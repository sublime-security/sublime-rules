name: "DLP: EU Debit Card Number"
description: "Detects messages containing European debit card numbers."
type: "rule"
severity: "high"
source: |
  type.outbound
  and any(attachments,
          (
            .file_extension in~ $file_extensions_common_archives
            or .file_extension in~ ('.csv', '.txt', '.xlsx', '.xls')
          )
          and any(file.explode(.),
                  // Debit card: 13-19 digits with optional spaces/hyphens
                  regex.contains(.scan.ocr.raw, '\b(?:\d{4}[\s\-]?){3}\d{1,7}\b')
          )
  )
  and (
    // EU country TLDs
    strings.icontains(sender.email.domain.tld, "at")
    or strings.icontains(sender.email.domain.tld, "be")
    or strings.icontains(sender.email.domain.tld, "bg")
    or strings.icontains(sender.email.domain.tld, "hr")
    or strings.icontains(sender.email.domain.tld, "cy")
    or strings.icontains(sender.email.domain.tld, "cz")
    or strings.icontains(sender.email.domain.tld, "dk")
    or strings.icontains(sender.email.domain.tld, "ee")
    or strings.icontains(sender.email.domain.tld, "fi")
    or strings.icontains(sender.email.domain.tld, "fr")
    or strings.icontains(sender.email.domain.tld, "de")
    or strings.icontains(sender.email.domain.tld, "gr")
    or strings.icontains(sender.email.domain.tld, "hu")
    or strings.icontains(sender.email.domain.tld, "ie")
    or strings.icontains(sender.email.domain.tld, "it")
    or strings.icontains(sender.email.domain.tld, "lv")
    or strings.icontains(sender.email.domain.tld, "lt")
    or strings.icontains(sender.email.domain.tld, "lu")
    or strings.icontains(sender.email.domain.tld, "mt")
    or strings.icontains(sender.email.domain.tld, "nl")
    or strings.icontains(sender.email.domain.tld, "pl")
    or strings.icontains(sender.email.domain.tld, "pt")
    or strings.icontains(sender.email.domain.tld, "ro")
    or strings.icontains(sender.email.domain.tld, "sk")
    or strings.icontains(sender.email.domain.tld, "si")
    or strings.icontains(sender.email.domain.tld, "es")
    or strings.icontains(sender.email.domain.tld, "se")
    or strings.icontains(sender.email.domain.tld, "eu")
  )

detection_methods:
  - "File analysis"
  - "Optical Character Recognition"
