name: "Attachment: DOCX with hyperlink targeting recipient address"
description: "Detects DOCX attachments containing hyperlinks with anchor references that match recipient email addresses. This technique is commonly used to personalize malicious documents and evade detection."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and any(filter(attachments, .file_extension in ('docx', 'docm')),
          any(filter(file.explode(.), .file_name == 'word/document.xml'),
                  any(regex.iextract(.scan.strings.raw,
                                     '<w:hyperlink[^\>]*w:anchor="(?P<email_address>[^\"]+)"'
                      ),
                      .named_groups["email_address"] in map(recipients.to,
                                                            .email.email
                      )
                  )
          )
  )

attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
detection_methods:
  - "File analysis"
  - "Archive analysis"
  - "XML analysis"
id: "d2ff2c1e-2994-5ca2-8bf3-508213e11364"
og_id: "9ec8fa49-bda9-5e8f-876f-1e53a46d83ca"
testing_pr: 3472
testing_sha: d3b105df8b7dd1081294c526dbb48b6e035fde76