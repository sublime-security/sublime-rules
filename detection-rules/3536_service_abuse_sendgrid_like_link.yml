name: "Service abuse: SendGrid-formatted link with actor-controlled fragment"
description: "Detects messages containing SendGrid or SendGrid-like links with base64-encoded zlib-compressed JSON in the URL fragment, indicating potential abuse of legitimate email services for malicious purposes."
type: "rule"
severity: "high"
source: |
  type.inbound
  and length(body.links) < 10
  and any(body.links,
          // SendGrid or SendGrid-like links have been abused
          (
            .href_url.path == "/ls/click"
            or any(.href_url.query_params_decoded['upn'], . is not null)
          )
          // base64-encoded zlib-compressed JSON
          and regex.match(.href_url.fragment, 'eJy.{7}A.*')
  )

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "URL analysis"
id: "0a7da631-bb44-558f-b4b8-a0d15a9af9e1"
og_id: "cb511fe9-ff90-572a-ba6d-15debadf9352"
testing_pr: 3536
testing_sha: 109ebb791f80f3cc2f08b45ed078555165a67346