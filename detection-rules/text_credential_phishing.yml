name: "Credential phishing: suspicious language in message body (first-time sender)"
description: |
    Detects credential phishing attempts by analyzing text within the email body from first time senders.
type: "rule"
severity: "medium"
source: |
  type.inbound 
  and any([body.html.display_text, body.plain.raw],
  any(beta.ml_nlu_classifier(.).intent,
        .name == "cred_theft" and .confidence == "high"
      )
  )

  // Notes for NLU preview:
  // if needed: free file hosting link, free subdomain link
  // firebasestorage.googleapis.com
  // appspot[.]com in URL path
  // link not in tranco 1m

  // if needed: suspicious sender TLD (eg co.jp)

  and (
          (
              sender.email.domain.root_domain in $free_email_providers
              and sender.email.email not in $sender_emails
          )
          or (
              sender.email.domain.root_domain not in $free_email_providers
              and sender.email.domain.domain not in $sender_domains
          )
          or any(headers.hops, .authentication_results.dmarc == "fail")
          
          // recipient domain SLD is in the attachment filename,
          // eg: Sublimesecurity.png
          // or any(recipients.to, strings.icontains())
          or any(attachments, 
              any(recipients.to,
                  strings.icontains(..file_name, .email.domain.sld)
              )
          )
  )
tags:
  - "Machine Learning"
  - "Natural Language Understanding"
  - "Credential phishing"
  - "Suspicious link"