name: "Link: Office document loads remote document template"
description: |
  Recursively scans links for archives and Office documents to detect remote document template injection.
references:
  - "https://delivr.to/payloads?id=c7a7195e-0de3-428d-a32c-5fd59a3012da"
type: "rule"
severity: "medium"
source: |
  type.inbound 
  and any(body.links, 
      any(beta.linkanalysis(.).files_downloaded,
          (
              // office files
              .file_extension in~ ("doc", "docm", "docx", "dot", "dotm", "pptm", "ppsm", "xlm", "xls", "xlsb", "xlsm", "xlt", "xltm")
              or .file_extension in~ $file_extensions_common_archives
             )
             and any(file.explode(.),
                  .flavors.mime == "text/xml" and
                  any(.scan.strings.strings, regex.icontains(., ".*Target.*http.*dotm.*"))
             )
      )
  )
tags: 
  - "Suspicious attachment"
  - "Office exploit"
