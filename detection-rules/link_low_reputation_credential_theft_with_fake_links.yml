name: "Link: Password expiration credential theft with low reputation links"
description: |
  This rule detects messages referencing password expiration verbiage in which Natural Language Understanding identifies as credential theft.
  It inspects the links for a common confidence technique of including legitimate links in link display-text which do not function.
  It then validates the remaining functional links are of low reputation and not in $org_domains

type: "rule"
severity: "medium"
source: |
  type.inbound
  and strings.ilike(body.html.display_text, "*expir*")
  and strings.ilike(body.html.display_text, "*password*")
  and any(ml.nlu_classifier(body.html.display_text).intents, .name == "cred_theft")
  and any(body.links, .display_text is not null
      and .display_text != .href_url.url
      and .href_url.url == "#")
  
  and any(body.links, 
      beta.linkanalysis(.).effective_url.domain.domain not in $org_domains
          and (
                  (
                      // don't include high rep domains
                      beta.linkanalysis(.).effective_url.domain.domain not in $tranco_1m
                      and beta.linkanalysis(.).effective_url.domain.domain not in $umbrella_1m
                  )
              // if it's in Tranco or Umbrella, still include it if it's one of these
              or beta.linkanalysis(.).effective_url.domain.domain in $free_file_hosts
              or beta.linkanalysis(.).effective_url.domain.root_domain in $free_subdomain_hosts
          )
    )
  
tags: 
  - "Credential phishing"
  - "Suspicious Link"
  - "Natural Language Understanding"
