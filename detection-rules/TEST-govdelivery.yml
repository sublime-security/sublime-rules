name: "Vendor Compromise: GovDelivery Message With Suspicious Link (no LinkAnalysis)"
description: "Detects messages from GovDelivery that contain links to non-government domains, URL shorteners, newly registered domains, or domains with suspicious redirects. GovDelivery is a digital communications system that lets government agencies send updates via email, text, and social media. We have observed compromised American municipal and county GovDelivery delivering phishing emails."
severity: "high"
source: |
  type.inbound
  and sender.email.domain.domain == "public.govdelivery.com"
  and headers.auth_summary.spf.pass
  and headers.auth_summary.dmarc.pass
  and length(body.links) < 10
  and any(body.links,
          any(filter(regex.extract(.href_url.path, '/CL0/(?P<url>.*?)/1/'),
                     strings.parse_url(.named_groups["url"]).domain.root_domain not in (
                       "google.com",
                       "govdelivery.com",
                       "granicus.com"
                     )
                     and strings.parse_url(.named_groups["url"]).domain.tld not in (
                       "gov"
                     )
              ),
              // this is inside the filter to avoid flagging this condition on known link domains, as listed above
              any(ml.nlu_classifier(..display_text).intents,
                  .name == "cred_theft"
              )
              or strings.parse_url(.named_groups["url"]).domain.domain in $url_shorteners
              or strings.parse_url(.named_groups["url"]).domain.root_domain in $url_shorteners
              or strings.parse_url(.named_groups["url"]).domain.domain in $free_subdomain_hosts
              or strings.parse_url(.named_groups["url"]).domain.root_domain in $free_subdomain_hosts
              or network.whois(strings.parse_url(.named_groups["url"]).domain).days_old < 30
          )
  )

attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Free subdomain host"
  - "IPFS"
  - "Social engineering"
  - "Evasion"
  - "Impersonation: Brand"
detection_methods:
  - "Natural Language Understanding"
  - "URL analysis"
  - "Whois"
id: "b4e2a2fb-7417-59b5-955b-b235bc6e4850"
