name: "PR# 3776 - Spam: Fake dating profile notification"
description: "Detects dating-themed messages from free email providers containing links with the recipient's email address embedded in URL parameters, combined with suspicious language or topics in the message body."
type: "rule"
severity: "low"
source: |
  type.inbound
  and (
    sender.email.domain.root_domain in $free_email_providers
    or (
      // Google Calendar invite
      strings.starts_with(subject.base, "Invitation:")
      and length(attachments) == 2
      and all(attachments,
              .content_type == "text/calendar" or .file_extension == "ics"
      )
    )
  )
  // not a reply
  and length(headers.references) == 0
  and 0 < length(distinct(body.current_thread.links, .href_url.domain.root_domain)
  ) <= 3
  and any(body.links,
          any(.href_url.query_params_decoded["email"],
              strings.parse_email(.).email in map(recipients.to, .email.email)
          )
          or .href_url.domain.domain == "sites.google.com"
          or strings.ilike(.href_url.path,
                           "*Flirt*",
                           "*Singles*",
                           "*Dating*",
                           "*Girls*",
          )
  )
  and (
    any(ml.nlu_classifier(body.current_thread.text).entities,
        .name == "org"
        and strings.ilike(.text,
                          "*Flirt*",
                          "*Singles*",
                          "*Date*",
                          "*Dating*",
                          "*Girls*",
                          "*Love*"
        )
    )
    or any(ml.nlu_classifier(body.current_thread.text).topics, .name == "Romance")
  )
  // negate iCloud Private Message Relay
  and not (
    sender.email.domain.root_domain == "privaterelay.appleid.com"
    or any(headers.hops, any(.fields, .name == "X-ICLOUD-HME"))
  )

attack_types:
  - "Spam"
tactics_and_techniques:
  - "Free email provider"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Natural Language Understanding"
  - "Sender analysis"
  - "URL analysis"
id: "bcb65f03-a92d-5fe8-9a0f-b6f1568bf907"
tags:
  - created_from_open_prs
  - rule_status_modified
  - pr_author_peterdj45
references:
  - https://github.com/sublime-security/sublime-rules/pull/3776