name: "Extortion / Sextortion - PDF attachment leveraging breach data from freemail sender"
description: "Detects sextortion attempts leveraging breach data, including names, addresses, phone numbers and frequently using Google Maps/Bing Maps streetview images to bolster confidence and fear."
type: "rule"
severity: "high"
source: |
  type.inbound
  and sender.email.domain.root_domain in $free_email_providers
  and any(attachments,
          strings.ilevenshtein(strings.concat(subject.subject,
                                              ".",
                                              .file_extension
                               ),
                               .file_name
          ) <= 1
  )
  and (
    regex.icontains(body.current_thread.text,
                    '\d+\s[\w\s.]+(?:\n)?[\w\s]+\s[A-Z]{2}\s\d{5}(?:-\d{4})?(?:\n)?'
    )
    or subject.subject == body.current_thread.text
  )
  
  and any(attachments,
          .file_type == "pdf"
          and any(file.explode(.),
                  (.depth == 1 and .flavors.mime == "image/jpeg")
                  and .scan.exiftool.image_height == 148
                  and .scan.exiftool.image_width == 148
                  and regex.match(.scan.qr.data,
                                  '(1[a-km-zA-HJ-NP-Z1-9]{25,34}|3[a-km-zA-HJ-NP-Z1-9]{25,34}|bc1[qp-z0-9]{39,59})'
                  )
          )
  )
  

attack_types:
  - "BEC/Fraud"
tactics_and_techniques:
  - "Free email provider"
  - "PDF"
  - "Social engineering"
  - "QR code"
detection_methods:
  - "Content analysis"
  - "File analysis"
  - "QR code analysis"
