name: "Impersonation: SharePoint Reply Header Anomaly"
description: "Detects messages with SharePoint reply headers that lack standard reply characteristics and contain inconsistencies in thread elements and recipient patterns"
type: "rule"
severity: "medium"
source: "type.inbound\n// appears to be a reply \nand strings.istarts_with(headers.in_reply_to, '<Share-')\nand strings.ends_with(headers.in_reply_to, '@odspnotify>')\nand ( // but lacks other reply elements\n  not (\n    (\n      strings.istarts_with(subject.subject, \"RE:\")\n      or strings.istarts_with(subject.subject, \"RES:\")\n      or strings.istarts_with(subject.subject, \"R:\")\n      or strings.istarts_with(subject.subject, \"ODG:\")\n      or strings.istarts_with(subject.subject,\n                              \"答复:\"\n      ) // response\n      or strings.istarts_with(subject.subject,\n                              \"回复:\"\n      ) // reply\n      or strings.istarts_with(subject.subject, \"AW:\")\n      or strings.istarts_with(subject.subject, \"TR:\")\n      or strings.istarts_with(subject.subject, \"FWD:\")\n      or strings.istarts_with(subject.subject, \"Resposta automática:\")\n      or strings.istarts_with(subject.subject, \"Automatische Antwort:\")\n      or strings.istarts_with(subject.subject, \"Autosvar:\")\n      or regex.icontains(subject.subject,\n                         '^(?:(?:\\[[^\\]]+\\]\\s?|EXT(?:ERNAL)?\\s?){0,3}|[[:punct:]]{0,3}\\w+[[:punct:]]{0,3}\\s)(?:r[ev]|fwd?|automat(ic|ed) reply)\\s?:'\n      )\n    )\n  )\n  // the sender is the recipient \n  // or the recipients are hidden\n  or (\n    sender.email.email in map(recipients.to, .email.email)\n    or length(recipients.to) == 0\n    or all(recipients.to, .email.email is null or .email.email == \"\")\n  )\n)\n\n// lack a previous thread with sharepoint stuff\nand not any([body.current_thread.text, body.html.display_text, body.plain.raw],\n            3 of (\n              strings.icontains(., \"from:\"),\n              strings.icontains(., \"to:\"),\n              strings.icontains(., \"sent:\"),\n              strings.icontains(., \"date:\"),\n              strings.icontains(., \"cc:\"),\n              strings.icontains(., \"subject:\")\n            )\n            and regex.icontains(.,\n                                '(?:from|to|sent|date|cc|subject|wrote):.*shared with you',\n                                '(?:from|to|sent|date|cc|subject|wrote):.*shared the folder .* with you',\n                                '(?:from|to|sent|date|cc|subject|wrote):.*invited you to view a file',\n\n            )\n)\n\n// // negate bouncebacks and undeliverables\nand not any(attachments,\n            .content_type in (\n              \"message/global-delivery-status\",\n              \"message/delivery-status\"\n            )\n)\n"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Impersonation: Brand"
  - "Evasion"
  - "Spoofing"
detection_methods:
  - "Header analysis"
  - "Content analysis"
  - "Sender analysis"
id: "78875848-71ba-5685-ba1c-00c5269cad23"
testing_pr: 2307
testing_sha: 87662cbde1bc817700db94538c6df797981a83c6
