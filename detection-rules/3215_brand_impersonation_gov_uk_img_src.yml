name: "Brand impersonation: UK .gov.uk domain spoofing"
description: "Detects messages containing UK government (.gov.uk) content and images while not originating from verified .gov.uk senders with proper DMARC authentication."
type: "rule"
severity: "high"
source: |
  type.inbound
  and strings.icontains(body.html.raw, '.gov.uk')
  and any(html.xpath(body.html, '//img/@src').nodes,
          strings.parse_url(.raw).domain.tld == "gov.uk"
  )
  and not (
    sender.email.domain.tld == "gov.uk"
    and coalesce(headers.auth_summary.dmarc.pass, false)
  )
  and length(body.links) < 20
  
  // not a forward or reply
  and (headers.in_reply_to is null or length(headers.references) == 0)

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "HTML analysis"
  - "Sender analysis"
  - "URL analysis"
id: "b874dbb9-57f4-5c0e-bbaa-036e8a51c504"
og_id: "ee489b17-cba9-5305-909d-5b2be68a0b00"
testing_pr: 3215
testing_sha: 3bd957caa5b5ee85e2c0b4ef5bd8c47de0ca893f