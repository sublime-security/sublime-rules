name: "Brand impersonation: Punchbowl"
description: "Detects messages impersonating Punchbowl invitations not originating from legitimate Punchbowl domain."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and strings.contains(body.html.raw, 'evitecdn.com')
  and length(filter(html.xpath(body.html, '//img/@src').nodes,
                    // calling parse_url allows url decoding to help us
                    strings.parse_url(.raw).domain.root_domain == 'evitecdn.com'
             )
  ) >= 2
  and length(filter(body.links,
                         .href_url.domain.root_domain == "evite.com"
                         and regex.contains(.href_url.path, '^/_ct/[a-f0-9]{40}/')
                  )
  ) < 3
  and not (
    (subject.is_forward or subject.is_reply)
    and (length(headers.references) != 0 or headers.in_reply_to is not null)
    and length(body.previous_threads) > 0
  )
  and not (
    sender.email.domain.root_domain == "evite.com"
    and headers.auth_summary.dmarc.pass
  )

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
id: "a2729c45-3343-5d1e-aee4-5dd558d1d24a"
og_id: "58937ba0-6966-559a-bd4f-759ee8b2979e"
testing_pr: 3313
testing_sha: 5a2fd4f0b698dc392908bd696922aef88fc92dd0