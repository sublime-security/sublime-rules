name: "Brand impersonation: Calendly with reply-to mismatch"
description: "Detects messages impersonating Calendly through display name, subject, or links while having a mismatched reply-to address. The rule validates legitimate Calendly senders through SPF/DMARC authentication and flags unsolicited messages from untrusted domains or those with suspicious reply-to configurations."
type: "rule"
severity: "medium"
source: |
  type.inbound

  // Legitimate Calendly sending infrastructure
  and (
    sender.email.domain.domain == "calendly.com"
    or strings.icontains(sender.display_name, 'calendly')
    or strings.icontains(subject.subject, 'calendly')
    or any(body.links, .href_url.domain.domain == "calendly.com")
  )
  
  // Verify SPF/DMARC for actual calendly.com senders
  and (
    sender.email.domain.domain != "calendly.com"
    or (headers.auth_summary.spf.pass and headers.auth_summary.dmarc.pass)
  )
  
  // negate phishing simulations
  and not profile.by_sender().any_false_positives
  
  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
  // negate Mailchimp senders
  and (
    sender.email.domain.root_domain not in~ (
      'mailchimp.com',
      'mcsv.net',
      'mcdlv.net'
    )
    and headers.return_path.domain.root_domain not in~ (
      'mailchimp.com',
      'mcsv.net',
      'mcdlv.net'
    )
    and not any(headers.hops,
                any(.fields,
                    .name == "X-Mailer" and strings.icontains(.value, "mailchimp")
                )
    )
  )
  
  // negate Google Groups senders
  and (
    sender.email.domain.root_domain != "googlegroups.com"
    and headers.return_path.domain.root_domain != "googlegroups.com"
    and not any(headers.hops,
                any(.fields,
                    .name == "X-BeenThere"
                    and strings.icontains(.value, "googlegroups.com")
                )
    )
  )
  
  // negate benign topics using ML classifier
  and (
    not any(ml.nlu_classifier(body.current_thread.text).topics,
            .name in (
              "Newsletters and Digests",
              "Advertising and Promotions",
              "Educational and Research",
              "Health and Wellness",
              "Romance",
              "Sexually Explicit Messages",
              "Acts of Violence",
              "Voicemail Call and Missed Call Notifications",
              "News and Current Events",
              "Secure Message",
              "Legal and Compliance"
            )
            and .confidence == "high"
    )
  )
  
  // FLAG ONLY: Calendly URLs with crypto/financial scam keywords in path
  // Detects ELUSIVE COMET and similar targeted campaigns
  // Using word boundaries to avoid false positives
  and any(body.links,
          .href_url.domain.domain == "calendly.com"
          and regex.icontains(.href_url.path,
                              '\b(crypto|bitcoin|btc|ethereum|eth|blockchain|nft|defi|web3|token|coin|trading|investment|forex|binance|coinbase|block|bloomberg|series|conference|media)\b'
          )
  )
  
  // STRICT sender requirements: must be BOTH unsolicited AND no benign history
  and not profile.by_sender().solicited
  and not profile.by_sender().any_messages_benign
  
tags:
  - "Hunt"
  - "Calendly"
  - "Scheduling service"
attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
  - "Spoofing"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
  - "Content analysis"
id: "12df6047-ed10-5e97-9038-d9b94bdb24d4"
og_id: "5e2e0377-df8c-5032-8963-09e98a39226d"
testing_pr: 3549
testing_sha: 0e413c85e428d89b5d487cd62d053506f62cd39b