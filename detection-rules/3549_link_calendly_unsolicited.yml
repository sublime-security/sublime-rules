name: "PR# 3549 - Brand impersonation: Calendly with reply-to mismatch"
description: "Detects messages impersonating Calendly through display name, subject, or links while having a mismatched reply-to address. The rule validates legitimate Calendly senders through SPF/DMARC authentication and flags unsolicited messages from untrusted domains or those with suspicious reply-to configurations."
type: "rule"
severity: "medium"
source: |
  type.inbound

  // Legitimate Calendly sending infrastructure
  and (
    sender.email.domain.domain == "calendly.com"
    or strings.icontains(sender.display_name, 'calendly')
    or strings.icontains(subject.subject, 'calendly')
    or any(body.links, .href_url.domain.domain == "calendly.com")
  )
  
  // Verify SPF/DMARC for actual calendly.com senders
  and (
    sender.email.domain.domain != "calendly.com"
    or (headers.auth_summary.spf.pass and headers.auth_summary.dmarc.pass)
  )
  
  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
  // negate Mailchimp senders
  and (
    sender.email.domain.root_domain not in~ (
      'mailchimp.com',
      'mcsv.net',
      'mcdlv.net'
    )
    and headers.return_path.domain.root_domain not in~ (
      'mailchimp.com',
      'mcsv.net',
      'mcdlv.net'
    )
    and not any(headers.hops,
                any(.fields,
                    .name == "X-Mailer" and strings.icontains(.value, "mailchimp")
                )
    )
  )
  
  // negate Google Groups senders
  and (
    sender.email.domain.root_domain != "googlegroups.com"
    and headers.return_path.domain.root_domain != "googlegroups.com"
    and not any(headers.hops,
                any(.fields,
                    .name == "X-BeenThere"
                    and strings.icontains(.value, "googlegroups.com")
                )
    )
  )

  // negate benign topics using ML classifier
  and (
    not any(ml.nlu_classifier(body.current_thread.text).topics,
            .name in (
              "Newsletters and Digests",
              "Advertising and Promotions",
              "Educational and Research",
              "Health and Wellness",
              "Romance",
              "Sexually Explicit Messages",
              "Acts of Violence",
              "Voicemail Call and Missed Call Notifications",
              "News and Current Events",
              "Secure Message",
              "Legal and Compliance"
            )
            and .confidence == "high"
    )
  )
  
  // flag if reply-to is present and mismatched with sender
  // OR if links exhibit credential phishing behavior
  // OR if Calendly URL contains crypto-related keywords in the path
  // OR if it's unsolicited B2B cold outreach or professional development with Calendly
  and (
    (
      length(headers.reply_to) > 0
      and all(headers.reply_to,
              .email.domain.root_domain != sender.email.domain.root_domain
      )
    )
    or any(body.links, ml.link_analysis(.).credphish.disposition == "phishing")
    or any(body.links,
           .href_url.domain.domain == "calendly.com"
           and regex.icontains(.href_url.path,
                               'crypto|bitcoin|btc|ethereum|eth|blockchain|nft|defi|web3|token|coin|trading|investment|forex|binance|coinbase'
           )
    )
    or any(ml.nlu_classifier(body.current_thread.text).topics,
           .name in ("B2B Cold Outreach", "Professional and Career Development")
           and .confidence == "high"
    )
  )
  
  // only flag unsolicited messages or those with malicious history
  and (
    not profile.by_sender().solicited
    or profile.by_sender().any_messages_malicious_or_spam
  )

  // negate senders with established benign history
  and not (
    profile.by_sender().any_messages_benign
    and not profile.by_sender().any_messages_malicious_or_spam
  )
  
tags:
  - "Hunt"
  - "Calendly"
  - "Scheduling service"
  - pr_author_brycampbell
  - created_from_open_prs
  - rule_status_added
attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
  - "Spoofing"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
  - "Content analysis"
id: "12df6047-ed10-5e97-9038-d9b94bdb24d4"
references:
  - https://github.com/sublime-security/sublime-rules/pull/3549