name: "Callback Phishing solicitation in message body"
description: "A fraudulent invoice/receipt found in the body of the message.\nCallback Phishing is an attempt by an attacker to solicit the victim (recipient) to call a phone number. \nThe resulting interaction could lead to a multitude of attacks ranging from Financial theft, Remote Access Trojan (RAT) Installation or Ransomware Deployment.\n"
type: "rule"
severity: "medium"
source: "type.inbound\nand length(attachments) == 0\nand (\n  not profile.by_sender().solicited\n  or (\n    profile.by_sender().any_messages_malicious_or_spam\n    and not profile.by_sender().any_false_positives\n  )\n)\nand (\n  sender.email.domain.root_domain in $free_email_providers\n  or sender.email.domain.tld in $suspicious_tlds\n  or network.whois(sender.email.domain).found == false\n  or headers.mailer in~ (\"Microsoft CDO for Windows 2000\")\n  or (\n    length(recipients.to) == 1\n    and all(recipients.to, .email.domain.domain not in $org_domains)\n  )\n)\nand (\n  // this section is synced with attachment_callback_phish_with_pdf.yml and attachment_callback_phish_with_img.yml\n  regex.icontains(body.current_thread.text,\n                  '(p.{0,3}a.{0,3}y.{0,3}p.{0,3}a.{0,3}l|ma?c.?fee|n[o0]rt[o0]n|geek.{0,5}squad|ebay|symantec|best buy|lifel[o0]c|secure anywhere|starz|utilities premium|pc security|at&t)'\n  )\n  or any(ml.logo_detect(beta.message_screenshot()).brands,\n         .name in (\"PayPal\", \"Norton\", \"GeekSquad\", \"Ebay\", \"McAfee\", \"AT&T\")\n  )\n)\nand length(body.current_thread.text) < 1750\nand (\n  (\n    // this seciton is synced with attachment_callback_phish_with_img.yml and attachment_callback_phish_with_pdf.yml\n    // however, the 3 of logic and requiring a phone number is specific to this rule in order to reduce FPs\n    // caused by messages which mention cancelling or otherwise managing a subscription\n    // it is also synced and below for message_screenshot OCR output\n    3 of (\n      strings.icontains(body.current_thread.text, 'purchase'),\n      strings.icontains(body.current_thread.text, 'payment'),\n      strings.icontains(body.current_thread.text, 'transaction'),\n      strings.icontains(body.current_thread.text, 'subscription'),\n      strings.icontains(body.current_thread.text, 'antivirus'),\n      strings.icontains(body.current_thread.text, 'order'),\n      strings.icontains(body.current_thread.text, 'support'),\n      strings.icontains(body.current_thread.text, 'help line'),\n      strings.icontains(body.current_thread.text, 'receipt'),\n      strings.icontains(body.current_thread.text, 'invoice'),\n      strings.icontains(body.current_thread.text, 'call'),\n      strings.icontains(body.current_thread.text, 'cancel'),\n      strings.icontains(body.current_thread.text, 'renew'),\n      strings.icontains(body.current_thread.text, 'refund'),\n      regex.icontains(body.current_thread.text, \"(?:reach|contact) us at\"),\n      strings.icontains(body.current_thread.text, \"+1\"),\n      strings.icontains(body.current_thread.text, \"amount\"),\n      strings.icontains(body.current_thread.text, \"charged\"),\n      strings.icontains(body.current_thread.text, \"crypto\"),\n      strings.icontains(body.current_thread.text, \"wallet address\"),\n      regex.icontains(body.current_thread.text, '\\$\\d{3}\\.\\d{2}\\b'),\n    )\n    // phone number regex\n    and regex.icontains(body.current_thread.text,\n                        '\\+?([ilo0-9]{1}.)?\\(?[ilo0-9]{3}?\\)?.[ilo0-9]{3}.?[ilo0-9]{4}',\n                        '\\+?([ilo0-9]{1,2})?\\s?\\(?\\d{3}\\)?[\\s\\.\\-⋅]{0,5}[ilo0-9]{3}[\\s\\.\\-⋅]{0,5}[ilo0-9]{4}'\n    )\n  )\n  or (\n    any(file.explode(beta.message_screenshot()),\n        // this seciton is synced with attachment_callback_phish_with_img.yml and attachment_callback_phish_with_pdf.yml\n        // and above for current_thread.text\n        3 of (\n          strings.icontains(.scan.ocr.raw, 'purchase'),\n          strings.icontains(.scan.ocr.raw, 'payment'),\n          strings.icontains(.scan.ocr.raw, 'transaction'),\n          strings.icontains(.scan.ocr.raw, 'subscription'),\n          strings.icontains(.scan.ocr.raw, 'antivirus'),\n          strings.icontains(.scan.ocr.raw, 'order'),\n          strings.icontains(.scan.ocr.raw, 'support'),\n          strings.icontains(.scan.ocr.raw, 'help line'),\n          strings.icontains(.scan.ocr.raw, 'receipt'),\n          strings.icontains(.scan.ocr.raw, 'invoice'),\n          strings.icontains(.scan.ocr.raw, 'call'),\n          strings.icontains(.scan.ocr.raw, 'helpdesk'),\n          strings.icontains(.scan.ocr.raw, 'cancel'),\n          strings.icontains(.scan.ocr.raw, 'renew'),\n          strings.icontains(.scan.ocr.raw, 'refund'),\n          regex.icontains(.scan.ocr.raw, \"(?:reach|contact) us at\"),\n          strings.icontains(.scan.ocr.raw, '+1'),\n          strings.icontains(.scan.ocr.raw, 'amount'),\n          strings.icontains(.scan.ocr.raw, 'charged'),\n          strings.icontains(.scan.ocr.raw, 'crypto'),\n          strings.icontains(.scan.ocr.raw, 'wallet address'),\n          regex.icontains(.scan.ocr.raw, '\\$\\d{3}\\.\\d{2}\\b'),\n        )\n        // phone number regex\n        and regex.icontains(.scan.ocr.raw,\n                            '\\+?([ilo0-9]{1}.)?\\(?[ilo0-9]{3}?\\)?.[ilo0-9]{3}.?[ilo0-9]{4}',\n                            '\\+?([ilo0-9]{1,2})?\\s?\\(?\\d{3}\\)?[\\s\\.\\-⋅]{0,5}[ilo0-9]{3}[\\s\\.\\-⋅]{0,5}[ilo0-9]{4}'\n        )\n\n        // negate messages with previous threads.  While callback phishing with thread hijacking or with current_thread \n        // padded with whitespace and previous threads in the message has been observed, the intetion of using OCR is for image embedded callbacks\n        and not regex.icount(.scan.ocr.raw,\n                             '(?:from|to|sent|date|cc|subject|wrote):'\n        ) > 3\n    )\n  )\n)\n// not high trust sender domains\nand (\n  (\n    sender.email.domain.root_domain in $high_trust_sender_root_domains\n    and not headers.auth_summary.dmarc.pass\n  )\n  or sender.email.domain.root_domain not in $high_trust_sender_root_domains\n)\nand not strings.ends_with(headers.message_id, \"@shopify.com>\")\n"
attack_types:
  - "Callback Phishing"
tactics_and_techniques:
  - "Free email provider"
  - "Impersonation: Brand"
  - "Out of band pivot"
  - "Social engineering"
detection_methods:
  - "File analysis"
  - "Sender analysis"
id: "10a3a446-c70f-5843-a4e4-4d815d33fcb1"
testing_pr: 2418
testing_sha: d705bf1dedc3b1b7b17c0c04a1a99adee20a1c50
