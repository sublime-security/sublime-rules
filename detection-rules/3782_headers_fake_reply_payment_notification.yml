name: "Headers: Fake reply with payment notification and attachment reference"
description: "Detects messages with payment-related subjects and bodies that reference attachments, appear to be replies but lack previous thread context, and come from untrusted senders without proper authentication."
type: "rule"
severity: "high"
source: |
  type.inbound
  and (
    strings.ilike(subject.subject,
                  "*payment*",
                  "*invoice*",
                  "*transaction*",
                  "*remittance*"
    )
    or strings.ilike(body.current_thread.text,
                     "*payment*advice*",
                     "*payment*notification*",
                     "*transaction*processed*",
                     "*incoming*payment*"
    )
  )
  and any(ml.nlu_classifier(body.current_thread.text).topics,
          .name == "Payment Information" and .confidence == "high"
  )
  and (
    strings.ilike(body.current_thread.text,
                  "*attach*advice*",
                  "*attach*payment*",
                  "*attached*"
    )
  )
  and headers.in_reply_to is not null
  and length(body.previous_threads) == 0
  and not (
    (
      sender.email.domain.root_domain in $tranco_50k
      or sender.email.domain.root_domain in $high_trust_sender_root_domains
    )
    and coalesce(headers.auth_summary.dmarc.pass, false)
  )

attack_types:
  - "BEC/Fraud"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Social engineering"
  - "Spoofing"
  - "Evasion"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Natural Language Understanding"
  - "Sender analysis"
id: "f436a835-83fe-5f3c-8c23-431831ca8e5e"
og_id: "eca2f0a5-372a-54f5-8255-3127fd35c8c8"
testing_pr: 3782
testing_sha: 25fe5b6d6b652392d291454c2ddc859e96747541