name: "Credential phishing: Generic document sharing"
description: |
  Detects credential phishing attempts using generic document sharing language
  where the sender claims to have sent a document for review, but the link
  doesn't point to legitimate file sharing services.
type: "rule"
severity: "medium"
source: |
  type.inbound
  and (
    // subject contains document sharing language
    regex.icontains(subject.subject,
                    '\b(has\s+sent\s+you|sent\s+you|shared\s+with\s+you|document\s+to\s+review|file\s+to\s+review|proposal\s+document|new\s+document)\b'
    )
    or strings.icontains(subject.subject, 'document to review')
    or strings.icontains(subject.subject, 'file to review')
    or strings.icontains(subject.subject, 'sent you')
  )
  and (
    // body contains document sharing language
    regex.icontains(body.current_thread.text,
                    '\b(document\s+I\s+sent|proposal\s+document|see\s+the\s+below|document.*review|file.*review|let\s+me\s+know\s+what\s+you\s+think)\b'
    )
    or strings.icontains(body.current_thread.text, 'document I sent')
    or strings.icontains(body.current_thread.text, 'proposal document')
    or strings.icontains(body.current_thread.text, 'let me know what you think')
  )
  // has links that look like file attachments but aren't
  and any(body.links,
          // display text looks like a file
          (
            regex.icontains(.display_text, '\.(pdf|doc|docx|xls|xlsx|ppt|pptx)')
            or regex.icontains(.display_text, '\d+kb|\d+mb')
            or strings.icontains(.display_text, 'document')
            or strings.icontains(.display_text, 'proposal')
            or strings.icontains(.display_text, 'review')
          )
          // but the URL doesn't point to legitimate file sharing
          and .href_url.domain.root_domain not in (
            "sharepoint.com",
            "google.com",
            "drive.google.com",
            "dropbox.com",
            "box.com",
            "onedrive.com",
            "1drv.ms",
            "aka.ms",
            "microsoft.com",
            "office.com",
            "docusign.com",
            "adobesign.com",
            "hellosign.com",
            "signable.app"
          )
          // and points to suspicious domains
          and (
            .href_url.domain.tld in $suspicious_tlds
            or .href_url.domain.root_domain in $url_shorteners
            or .href_url.domain.domain in $url_shorteners
            or .href_url.domain.root_domain in $free_file_hosts
            or .href_url.domain.domain in $free_file_hosts
            // or it's a forms/survey platform being abused in self_service_creation_platform_domains
            or .href_url.domain.root_domain in $self_service_creation_platform_domains
            or .href_url.domain.domain in $self_service_creation_platform_domains
          )
  )
  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  and (
    profile.by_sender().solicited == false
    or profile.by_sender_email().prevalence == "new"
    or profile.by_sender_email().days_since.last_contact > 30
    or (
      profile.by_sender().any_messages_malicious_or_spam
      and not profile.by_sender().any_messages_benign
    )
    // or it's a spoof of the org_domain
    or (
      sender.email.domain.domain in $org_domains
      and not (
        headers.auth_summary.spf.pass
        or coalesce(headers.auth_summary.dmarc.pass, false)
      )
    )
  )
  and not profile.by_sender().any_messages_benign
  // exclude if it's a reply to an existing conversation
  and not length(body.previous_threads) > 0
  
attack_types:
  - "Credential Phishing"
  - "BEC/Fraud"
tactics_and_techniques:
  - "Social engineering"
  - "Evasion"
  - "Impersonation: Employee"
detection_methods:
  - "Content analysis"
  - "Natural Language Understanding"
  - "URL analysis"
  - "Sender analysis"
id: "9f0e1d2c-3b4a-5c6d-7e8f-9a0b1c2d3e4f"
