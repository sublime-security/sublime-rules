name: "Attachment: Legal themed message with PDF containing suspicious link"
description: "Message contains urgent legal language, with an attached PDF containing links that redirect through URL shorteners, use suspicious TLDs or CAPTCHA pages."
type: "rule"
severity: "medium"
source: |
  type.inbound
  // short body or contains emoji
  and (
    length(body.current_thread.text) < 1500
    or regex.contains(body.plain.raw,
                      '[\x{1F300}-\x{1F5FF}\x{1F600}-\x{1F64F}\x{1F680}-\x{1F6FF}\x{1F700}-\x{1F77F}\x{1F780}-\x{1F7FF}\x{1F900}-\x{1F9FF}\x{2600}-\x{26FF}\x{2700}-\x{27BF}\x{2300}-\x{23FF}]'
    )
  )
  // legal with urgency
  and any(ml.nlu_classifier(body.html.display_text).topics,
          .name == "Legal and Compliance" and .confidence in ("medium", "high")
  )
  
  // is not a reply
  and length(headers.references) == 0
  and headers.in_reply_to is null
  and (
    // only one attachment
    length(attachments) == 1
    // or, any 2 attachments share the ~same file name
    or any(attachments,
           any(regex.extract(.file_name,
                             // the regex extracts the file name, discarding the file extention and any numbers in parens
                             // "test.txt" and "test (1).pdf" become "test"
                             '(?P<file_name>.*?)(?:\s*\([^)]+\))*\.[^.]+$'
               ),
               length(filter(attachments,
                             strings.istarts_with(.file_name,
                                                  ..named_groups["file_name"]
                             )
                      )
               ) > 1
           )
    )
  )
  and any(attachments,
          .file_extension == "pdf"
          and any(file.explode(.),
                  0 < length(.scan.pdf.urls) < 5
                  and (
                    // suspicious producer
                    strings.ilike(.scan.exiftool.producer,
                                  "*Google Docs Renderer*",
                                  "*Skia/PDF*"
                    )
                    and any(.scan.pdf.urls,
                            // with links that are URL shortners
                            .domain.root_domain in $url_shorteners
                            or .domain.domain in $url_shorteners
                            or network.whois(.domain).days_old < 14
                            // when visiting those links, the link it is sus
                            or ml.link_analysis(.).effective_url.domain.tld in $suspicious_tlds
                            or ml.link_analysis(.).credphish.contains_captcha
                            or ml.link_analysis(.).credphish.disposition == "phishing"
                            or strings.icontains(ml.link_analysis(.).final_dom.display_text,
                                                 "I'm Human"
                            )
                    )
                  )
          )
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "PDF"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "File analysis"
  - "Header analysis"
  - "Natural Language Understanding"
  - "URL analysis"
id: "19133301-8bc0-5a91-b044-fb72cba16bbe"
