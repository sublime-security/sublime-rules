name: "Suspected Cross-Site Scripting (XSS) found in subject"
description: "This rule detects Cross-Site Scripting (XSS) attempts within email subjects. It bypasses messages from highly trusted domains unless they fail authentication. However, the rule remains flexible, triggering even for trusted domains when emails are sent from Google Groups, ensuring thorough protection against potential threats while minimizing false positives."
type: "rule"
severity: "medium"
source: "type.inbound\n// subject contains suspected cross site scripting\nand regex.icontains(subject.subject,\n                '(?:[<]|%3c|\\\\u003c|\\\\x3c|&[lg]t;|&n[vw][lg]t;)\\/?(?:script(?:\\s*/?\\s*src\\s*=)?|iframe|embed|object|style|form|meta|link|svg|img|audio|video|source|body|input|textarea|select|noscript)',\n                // constructor chain pattern\n                'constructor\\.constructor|\\[\\s*constructor\\s*\\]|\\.__proto__|\\[constructor\\]'\n)\n\n// and contains html or url encoded strings, hex escaped strings, opening or closing html tags, or escaped non word characters\nand // subject contains common event handlers\n regex.icontains(subject.subject,\n                 '\\b(?:on(?:abort|blur|change|click|dblclick|error|focus|load|mousedown|mousemove|mouseout|mouseover|mouseup|reset|select|submit|unload)|srcdoc|src\\s*=)',\n                 // subject contains javascript funcitons\n                 '\\b(?:javascript|eval|settimeout|setinterval|document\\.(?:cookie|write|location|createElement|body|appendChild)|fetch|constructor|__proto__|prototype)\\b'\n)\nand regex.icontains(subject.subject,\n                    // Pattern 1: Quote followed by various special characters in encoded/literal forms:\n                    // - < > angle brackets (%3C, %3E, literal, &lt;, &gt;)\n                    // - quotes (&quot;, &apos;)\n                    // - parentheses (&lpar;, &rpar;)\n                    // - curly braces (&lcub;, &rcub;)\n                    // - square brackets (&lsqb;, &rsqb;)\n                    // - equals sign (&equals;)\n                    // - forward/backward slashes (&sol;, &bsol;)\n                    // - colon (&colon;)\n                    // - semicolon (&semi;)\n                    '[\\x27\\x22](?:%3[CE]|[<>]|&(?:lt|gt|quot|apos|[lr](?:par|cub|sqb)|equals|[bs]ol|colon|semi)\\x3b)',\n                    // Pattern 2: Encoded/special characters followed by quote\n                    // Same as above but in reverse order - special chars followed by quote\n                    '(?:%3[CE]|[<>]|&(?:lt|gt|quot|apos|[lr](?:par|cub|sqb)|equals|[bs]ol|colon|semi)\\x3b)[\\x27\\x22]',\n\n                    // Pattern 3: Hexadecimal or decimal HTML entities with semicolon\n                    // e.g., &#x27; (hex) or &#39; (decimal)\n                    '&#[xX]?[a-f0-9]+;',\n\n                    // Pattern 4: Raw decimal HTML entities\n                    // e.g., &#60 (without semicolon)\n                    '&#\\d+',\n\n                    // Pattern 5: URL encoded characters\n                    // e.g., %3C for <, %3E for >, %22 for \", %27 for '\n                    '%[a-f0-9]{2}',\n\n                    // Pattern 6: Unicode/hex escapes\n                    // e.g., \\u003C for <, \\x3C for \n                    '\\\\[xXuU][a-f0-9]{4}',\n                    // New patterns for this type of payload\n                    '</[^>]+/[^>]+>', // Matches closing tags with slash delimiters\n                    '//[^\"\\x27>\\s]+', // Matches protocol-relative URLs\n                    'xss\\.report', // Specific known XSS domains\n)\n\n// negate highly trusted sender domains unless they fail DMARC authentication\nand (\n  (\n    sender.email.domain.root_domain in $high_trust_sender_root_domains\n    and (\n      any(distinct(headers.hops, .authentication_results.dmarc is not null),\n          strings.ilike(.authentication_results.dmarc, \"*fail\")\n      )\n      or (\n        strings.icontains(sender.display_name, \"via\")\n        and any(headers.hops,\n                any(.fields,\n                    .name == \"List-ID\"\n                    and strings.ends_with(.value,\n                                          strings.concat(sender.email.domain.domain,\n                                                         \">\"\n                                          )\n                    )\n                )\n        )\n      )\n    )\n  )\n  or sender.email.domain.root_domain not in $high_trust_sender_root_domains\n)\n"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Scripting"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
id: "8a946cfa-58ea-59c5-9726-94a1892b5556"
testing_pr: 2408
testing_sha: 1539f50e046421060925f2cfd40caf0c9c0dc129
