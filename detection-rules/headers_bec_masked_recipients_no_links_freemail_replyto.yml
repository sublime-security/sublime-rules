name: "Business Email Compromise: Masked recipients with suspicious reply-to mismatch (unsolicited)"
description: |
  This rule detects unsolicited messages where the recipient matches the sender address and no other recipients are identified.
  The reply-to address does not match the sender, and is a freemail with no links in the body.
  This a common combination of techniques used by low level BEC threats. 
type: "rule"
severity: "medium"
source: |
  type.inbound 
  
  and any(recipients.to, .email.email == sender.email.email)
  and length(recipients.cc) == 0
  and length(recipients.bcc) == 0
  
  and length(body.links) == 0 
  
  and any(headers.reply_to,
      .email.domain.domain in $free_email_providers
      and not .email.domain.domain == sender.email.domain.domain
  )
  
  and (
          (
              sender.email.domain.root_domain in $free_email_providers
              and sender.email.email not in $recipient_emails
          )
          or (
              sender.email.domain.root_domain not in $free_email_providers
              and sender.email.domain.domain not in $recipient_domains
          )
  )
tags: 
  - "Suspicious sender"
  - "Suspicious headers"
  - "Business Email Compromise"
