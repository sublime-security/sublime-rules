name: "PR# 3788 - Brand impersonation: Blue Cross Blue Shield with suspicious indicators"
description: "Detects messages impersonating Blue Cross Blue Shield brands from suspicious senders. It flags messages from domains younger than one year or older domains with authentication failures, suspicious links, or other risk indicators."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and regex.icontains(body.current_thread.text,
                      '\bblue[- ]?cross\b',
                      '\bblue[- ]?shield\b',
                      '\bbcbs\b'
  )
  and (
    regex.icontains(body.current_thread.text,
                    '\b(?:m[ei]d[il]care|health).{0,10}(?:kit|package)\b'
    )
    or (
      regex.icontains(body.current_thread.text, 'review.{0,8}document')
      and any(ml.nlu_classifier(body.current_thread.text).intents,
              .name == "cred_theft" and .confidence == 'high'
      )
    )
  )
  
  // link restriction
  and 1 <= length(body.links) <= 9
  
  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
  // negate org domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $org_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $org_domains
  )
  
  // negate legitimate conversations
  and not (
    (subject.is_forward or subject.is_reply) and headers.in_reply_to is not null
  )
  
  // topic negations
  and not any(ml.nlu_classifier(body.current_thread.text).topics,
              .name in ("Professional and Career Development", "Political Mail")
  )
  
  // younger domain
  and (
    network.whois(sender.email.domain).days_old <= 365
    // older domain with conditions
    or (
      network.whois(sender.email.domain).days_old >= 365
      // sketchy sender
      and (
        not headers.auth_summary.dmarc.pass
        or not headers.auth_summary.spf.pass
        or 'fail' in~ distinct(map(headers.hops, .authentication_results.dkim))
        or any(headers.reply_to, network.whois(.email.domain).days_old < 30)
        or sender.email.domain.root_domain in $free_email_providers
        or (
          all(recipients.to, .email.email == sender.email.email)
          and length(recipients.cc) == 0
          and length(recipients.bcc) == 0
        )
        // sketchy content
        or (
          any(body.links,
              network.whois(.href_url.domain).days_old < 30
              or .href_url.domain.domain in $url_shorteners
          )
        )
        // links don't match sender
        or all(body.links,
               .href_url.domain.root_domain != sender.email.domain.root_domain
               and not (
                 .href_url.domain.root_domain == "mimecastprotect.com"
                 and strings.parse_domain(.href_url.query_params_decoded["domain"][0]
                 ).root_domain == sender.email.domain.root_domain
               )
        )
      )
    )
  )

attack_types:
  - "Credential Phishing"
  - "Spam"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Natural Language Understanding"
  - "Header analysis"
  - "Sender analysis"
  - "URL analysis"
  - "Whois"
id: "7022235d-50a1-5475-ba98-c5cd7326e2b1"
tags:
  - created_from_open_prs
  - rule_status_added
  - pr_author_missingn0pe
references:
  - https://github.com/sublime-security/sublime-rules/pull/3788