name: "Spam: Website errors solicitation"
description: "This rule detects messages claiming to have identified errors on a website. The messages typically offer to send pricing or information upon request."
type: "rule"
severity: "low"
source: |
  type.inbound
  and not profile.by_sender().solicited
  
  and length(attachments) == 0
  
  // allow no links, or 1 link that is unsubscribe/org domain
  and (
    length(body.links) == 0
    or (
      length(body.links) == 1
      and (
        regex.icontains(body.html.raw, "mailto:*[++unsubscribe@]")
        or any(body.links, .href_url.domain.root_domain in~ $org_domains)
      )
    )
  )
  
  and (
    regex.icontains(strings.replace_confusables(subject.subject),
                    "(?:proposal|cost|estimate|error|bug|audit|screenshot|strategy|rankings|issues|fix|website|design)"
    )
    or (
      strings.icontains(strings.replace_confusables(subject.subject), "report")
      and (
        regex.icontains(strings.replace_confusables(body.current_thread.text),
                        "(?:free|send you|can i send|may i send|let me know|interested|get back to me|reply back)"
        )
        or any(body.previous_threads,
               regex.icontains(strings.replace_confusables(.text),
                               "(?:free|send you|can i send|may i send|let me know|interested|get back to me|reply back)"
               )
        )
      )
    )
    or length(subject.base) < 5
    or subject.is_reply or subject.is_forward
  )
  
  and (
    // Single thread messages
    (
      length(body.previous_threads) == 0
      and 20 < length(body.current_thread.text) < 500
      and regex.icontains(strings.replace_confusables(body.current_thread.text),
                          "(?:screenshot|error list|plan|quote|rank|professional|price|mistake)"
      )
      and regex.icontains(strings.replace_confusables(body.current_thread.text),
                          'h(?:i|ello|ey)\b'
      )
      and regex.icontains(strings.replace_confusables(body.current_thread.text),
                          "(?:error|report|issues|repair|redesign|upgrade)"
      )
      and regex.icontains(strings.replace_confusables(body.current_thread.text),
                          "(?:site|website|page)"
      )
    )
    or
    // Multiple thread messages
    (
      length(body.links) == 0
      and 0 < length(body.previous_threads) < 5
      and any(body.previous_threads,
              regex.icontains(strings.replace_confusables(.text),
                              "(?:screenshot|website)"
              )
      )
      and any(body.previous_threads,
              length(.text) < 400
              and (
                regex.icontains(strings.replace_confusables(.text),
                                'h(?:i|ello|ey)\b'
                )
                or strings.icontains(strings.replace_confusables(.text), "morning")
              )
              and regex.icontains(strings.replace_confusables(.text),
                                  '(?:\berror(?:\s+list)?\b|screenshot|report|plan)'
              )
              and ml.nlu_classifier(.text).language == "english"
      )
    )
  )

tags:
  - "Attack surface reduction"
attack_types:
  - "Spam"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
  - "Natural Language Understanding"
id: "ae92f4f9-e030-5287-bad1-c1f7bf3ccdfc"
og_id: "122ea794-f619-5f29-acb2-83261d8f81fc"
testing_pr: 3639
testing_sha: 9dd4df8958d676545a6f800593b6816c5ebeed5b