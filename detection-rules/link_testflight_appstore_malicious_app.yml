name: "Link: Malicious mobile app via TestFlight or App Store from freemail provider"
description: "Detects emails containing links to the Apple App Store or TestFlight beta testing store applications sent from free email providers, which may indicate malware, unauthorized app distribution or social engineering tactics."
type: "rule"
severity: "high"
source: |
  type.inbound
  and any(body.links,
          .href_url.domain.domain in ('apps.apple.com', 'testflight.apple.com')
          or (
            .href_url.domain.root_domain == "mimecastprotect.com"
            and any(.href_url.query_params_decoded['domain'],
                    . in ("apps.apple.com, testflight.apple.com")
            )
          )
  )
  and any(html.xpath(body.html, '//a').nodes,
          (
            strings.icontains(.raw, 'apps.apple.com')
            or strings.icontains(.raw, 'testflight.apple.com')
          )
          and not strings.contains(.raw, '<img')
  )
  and sender.email.domain.domain in $free_email_providers

attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Free email provider"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "HTML analysis"
  - "Sender analysis"
  - "URL analysis"
