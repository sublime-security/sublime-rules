name: "Link: Payment advice with missing attachment and suspicious indicators"
description: "Detects messages claiming to contain payment advice or attachments that are either missing or suspiciously small, combined with external links to domains with different registrars. The message appears to be a reply but lacks previous thread context, indicating potential thread hijacking or spoofing tactics."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and strings.ilike(subject.base,
                    "*payment*",
                    "*invoice*",
                    "*transaction*",
                    "*remittance*"
  )
  and any(body.current_thread.links,
          (strings.ilike(.display_text, "*view*payment*details*"))
  )
  and any(filter(body.current_thread.links,
                 .href_url.domain.root_domain != sender.email.domain.root_domain
          ),
          network.whois(sender.email.domain).registrar_name != network.whois(.href_url.domain
          ).registrar_name
          and (
            // paths like /000, /123
            regex.match(.href_url.path, '^/\d+/?$')
            // very short paths
            or regex.match(.href_url.path, '^/[a-z]{1,3}/?$')
          )
  )
  and headers.in_reply_to is not null
  and length(body.previous_threads) == 0
  and not (
    (
      sender.email.domain.root_domain in $tranco_50k
      or sender.email.domain.root_domain in $high_trust_sender_root_domains
    )
    and coalesce(headers.auth_summary.dmarc.pass, false)
  )
attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Spoofing"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Natural Language Understanding"
  - "Sender analysis"
  - "URL analysis"
  - "Whois"
id: "83e435b3-b94a-5f67-9536-7caf7606ca32"
