name: "PR# 3911 - VIP impersonation: Missing references & in-reply-to headers"
description: "Detects fake message threads where the sender impersonates organization VIPs by using their display names and email addresses in previous thread content, while lacking proper email threading headers like references and in-reply-to fields."
type: "rule"
severity: "high"
source: |
  type.inbound
  // referenced threads does not match previous threads
  and not length(headers.references) == length(body.previous_threads)
  // and the in_reply_to is null
  and headers.in_reply_to is null
  // org vip display name & email in previous threads
  and (
    any(body.previous_threads,
        any($org_vips, ..sender.display_name == .display_name)
    )
    and any(body.previous_threads, any($org_vips, ..sender.email.email == .email))
  )

attack_types:
  - "BEC/Fraud"
tactics_and_techniques:
  - "Impersonation: VIP"
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "Header analysis"
  - "Content analysis"
  - "Sender analysis"
id: "e1aa14d7-c054-590c-bd60-33e916663132"
tags:
  - created_from_open_prs
  - rule_status_added
  - pr_author_MSAdministrator
references:
  - https://github.com/sublime-security/sublime-rules/pull/3911