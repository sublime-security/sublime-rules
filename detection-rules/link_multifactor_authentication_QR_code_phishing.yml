name: "Link: Multi-Factor Authentication phishing via QR code"
description: |
  This rule detects verbiage related to Multi-factor authentication in the subject, body or attachments. The rule also checks for the presence of a QR code with a URL that contains the recipients email address, from an unsolicited sender.
references:
  
type: "rule"
severity: "medium"
source: |
  type.inbound 
  
  // body html, plain.raw subject or any attachments contain QR|2fa|MFA|Multi factor authentiation
  
  and (
      regex.icontains(subject.subject, '(\b2fa\b|\bQ.?R\.?\s?\b|MFA|Muti[ -]?Factor Auth(entication)?)') or
      regex.icontains(body.html.display_text, '(\b2fa\b|\bQ.?R\.?\s?\b|MFA|Muti[ -]?Factor Auth(entication)?)') or
      regex.icontains(body.plain.raw, '(\b2fa\b|\bQ.?R\.?\s?\b|MFA|Muti[ -]?Factor Auth(entication)?)') or
      (
          any(attachments,
              .file_type in~ ('bmp', 'png', 'jpg', 'jpeg', 'gif')
              and any(file.explode(.), 
                  any(.scan.strings.strings, regex.icontains(.,
                    '(\b2fa\b|\bQ.?R\.?\s?\b|MFA|Muti[ -]?Factor Auth(entication)?)'))
              )
          )
      )
  )
  
  // QR code is present in attachment & recipient email address is present in the URL, a common tactic used in credential phishing attacks
  and (
      any(attachments,
      .file_type in~ ('bmp', 'png', 'jpg', 'jpeg', 'gif')
          and any(file.explode(.), .scan.qr.data is not null
              and any(recipients.to, strings.icontains(..scan.qr.data, .email.email))
          )
      )
      or (
          any(file.explode(beta.message_screenshot()), .scan.qr.data is not null 
              and any(recipients.to, strings.icontains(..scan.qr.data, .email.email))
          )
      )
  )
  
  // unsolicited
  and (
          (
              sender.email.domain.root_domain in $free_email_providers
              and sender.email.email not in $recipient_emails
          )
          or (
              sender.email.domain.root_domain not in $free_email_providers
              and sender.email.domain.domain not in $recipient_domains
          )
  )
  
tags: 
  - "QR code"
  - "Suspicious Link"
  - "Unsolicited"
