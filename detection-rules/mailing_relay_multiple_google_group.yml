name: "Headers: Mailing list relay with multiple X-BeenThere headers"
description: "Detects messages relayed through mailing lists or groups where the sender's domain matches the recipient's domain (self-addressed) or where an unrelated sender is relaying through a group, combined with multiple X-BeenThere headers indicating potential mailing list abuse or routing manipulation."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and (
    // self-addressed through group
    any(recipients.to, .email.domain.domain == sender.email.domain.domain)
    or 
    // unrelated sender relaying through group
    (
      any(recipients.to,
          .email.domain.domain == headers.return_path.domain.domain
      )
      and sender.email.domain.root_domain != headers.return_path.domain.root_domain
    )
  )
  and sum(map(headers.hops,
              length(filter(.fields, strings.starts_with(.name, "X-BeenThere")))
          )
  ) > 1
  and not sender.email.domain.root_domain in $sender_domains

attack_types:
  - "BEC/Fraud"
  - "Spam"
tactics_and_techniques:
  - "Evasion"
  - "Spoofing"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
id: "5c1c3008-0dc5-5ca4-ae66-4ef2c7befaa3"
