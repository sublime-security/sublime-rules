name: "Link: Many URL rewrite encoders"
description: |
  Detects links that have been processed through many URL rewrite encoders, which may indicate obfuscation or evasion techniques.
type: "rule"
source: |
  type.inbound
  and 1 of (
    any(body.links,
        1 of (
          // 3 or more encoders but they are all the same ones
          length(.href_url.rewrite.encoders) >= 3
          and length(distinct(.href_url.rewrite.encoders)) == 1,
          // 4 or more encoders but they are all distinct
          length(.href_url.rewrite.encoders) >= 4
          and length(distinct(.href_url.rewrite.encoders)) >= 4,
        )
    ),
    any(attachments,
        any(file.explode(.),
            any(.scan.url.urls,
                1 of (
                  // 3 or more encoders but they are all the same ones
                  length(.rewrite.encoders) >= 3
                  and length(distinct(.rewrite.encoders)) == 1,
                  // 4 or more encoders but they are all distinct
                  length(.rewrite.encoders) >= 4
                  and length(distinct(.rewrite.encoders)) >= 4,
                )
            )
        )
    )
  )
severity: "high"
tags:
 - "Attack surface reduction"
 - "Suspicious Link"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
  - "Impersonation: Brand"
detection_methods:
  - "Content analysis"
id: "b88e53a7-9947-5c6b-bea9-d67906634655"
