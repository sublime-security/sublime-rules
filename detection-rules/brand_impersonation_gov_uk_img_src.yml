name: "Brand impersonation: UK .gov.uk domain spoofing"
description: "Detects messages containing UK government (.gov.uk) content and images while not originating from verified .gov.uk senders with proper DMARC authentication."
type: "rule"
severity: "high"
source: |
  type.inbound
  and strings.icontains(body.html.raw, '.gov.uk')
  and any(html.xpath(body.html, '//img/@src').nodes,
          strings.parse_url(.raw).domain.tld == "gov.uk"
  )
  and not (
    sender.email.domain.tld == "gov.uk"
    and coalesce(headers.auth_summary.dmarc.pass, false)
  )
  and length(body.links) < 20
  
  // not a forward or reply
  and (headers.in_reply_to is null or length(headers.references) == 0)

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "HTML analysis"
  - "Sender analysis"
  - "URL analysis"
