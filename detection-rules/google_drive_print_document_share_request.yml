name: "Google Drive: Suspicious Print Document Share Request"
description: "Detects Google Drive sharing requests for PDF documents with print-related filenames that come from external organizations. These types of messages may be used in targeted spear phishing campaigns where attackers attempt to get users to click on links to gain access to sensitive documents."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and sender.email.email in (
    "drive-shares-dm-noreply@google.com",
    "drive-shares-noreply@google.com"
  )
  and strings.icontains(subject.subject, "Share request")
  and strings.icontains(subject.subject, ".pdf")
  and strings.icontains(body.current_thread.text, "print")
  
  // Check for an outside organization warning
  and strings.contains(body.current_thread.text, "outside your organization") 
  
  // Check that there's a reply-to header from a domain not in the organization
  and length(headers.reply_to) > 0
  and not any(headers.reply_to, .email.domain.domain in $org_domains)
  
  // Check for Mimecast protection URLs that could be masking malicious links
  and any(body.links, strings.contains(.href_url.url, "mimecastprotect.com") or 
                       strings.contains(.href_url.url, "protect"))
  
  // Negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
  )

tags:
  - "Attack surface reduction"
attack_types:
  - "BEC/Fraud"
  - "Callback Phishing"
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Free file host"
  - "Impersonation: Business service"
detection_methods:
  - "Header analysis"
  - "Content analysis"
  - "Impersonation: Business service"
detection_methods:
  - "Header analysis"
  - "Content analysis"