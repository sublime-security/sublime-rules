name: "Link: Self-sent message with suspicious link containing sender identifiers"
description: "Detects messages where the sender emails themselves with a single suspicious link that contains the sender's local part or domain in the URL path and the link display text matches the subject line."
type: "rule"
severity: "medium"
source: |
  type.inbound
  // self sender
  and (
    length(recipients.to) == 1
    and sender.email.email == recipients.to[0].email.email
  )
  and length(body.current_thread.links) == 1
  and any(body.current_thread.links,
          strings.icontains(.display_text, subject.base)
          and (
            strings.icontains(.href_url.path, sender.email.local_part)
            or strings.icontains(.href_url.path, sender.email.domain.sld)
          )
          and (
            .href_url.domain.tld == "ru"
            or .href_url.domain.root_domain not in $tranco_1m
            or .href_url.domain.domain in $free_file_hosts
            or .href_url.domain.root_domain in $free_file_hosts
            or .href_url.domain.root_domain in $free_subdomain_hosts
            or .href_url.domain.domain in $url_shorteners
            or .href_url.domain.domain in $social_landing_hosts
            // account for URL rewrites
            or (
              any(.href_url.query_params_decoded["domain"],
                  strings.parse_domain(.).tld == "ru"
                  or strings.parse_domain(.).root_domain not in~ $tranco_1m
                  or strings.parse_domain(.).domain in~ $free_file_hosts
                  or strings.parse_domain(.).root_domain in~ $free_file_hosts
                  or strings.parse_domain(.).root_domain in~ $free_subdomain_hosts
                  or strings.parse_domain(.).domain in~ $url_shorteners
                  or strings.parse_domain(.).domain in~ $social_landing_hosts
              )
            )
            or 
  
            // mass mailer link, masks the actual URL
            .href_url.domain.root_domain in (
              "hubspotlinks.com",
              "mandrillapp.com",
              "sendgrid.net",
              "rs6.net"
            )
  
            // Google AMP redirect
            or (
              .href_url.domain.sld == "google"
              and strings.starts_with(.href_url.path, "/amp/")
            )
  
            // Recipient email address in link
            or any(body.links,
                   any(recipients.to,
                       strings.icontains(..href_url.url, .email.email)
                       and any(recipients.to, .email.domain.valid)
                   )
            )
            or .href_url.domain.root_domain == "beehiiv.com"
          )
  
          // exclude sources of potential FPs
          and (
            .href_url.domain.root_domain not in (
              "svc.ms",
              "sharepoint.com",
              "1drv.ms",
              "microsoft.com",
              "aka.ms",
              "msftauthimages.net",
              "office.com",
              "microsoftproject.com"
            )
            or any(body.links, .href_url.domain.domain in $free_file_hosts)
          )
          and .href_url.domain.root_domain not in $org_domains
          and .href_url.domain.valid
  ) 

attack_types:
  - "Credential Phishing"
  - "BEC/Fraud"
tactics_and_techniques:
  - "Free file host"
  - "Free subdomain host"
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "Header analysis"
  - "URL analysis"
  - "Sender analysis"
id: "4f1b23f7-65e9-580c-bde4-b7f2b780af01"
