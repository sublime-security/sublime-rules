name: "Link: Self-sent message with suspicious link containing sender identifiers"
description: "Detects messages where the sender emails themselves with a single suspicious link that contains the sender's local part or domain in the URL path and the link display text matches the subject line."
type: "rule"
severity: "medium"
source: |
  type.inbound
  // self sender
  and (
    length(recipients.to) == 1
    and sender.email.email == recipients.to[0].email.email
  )
  // one link that is not related to the sender via sld (to account for orgs that have multiple tlds)
  and length(distinct(filter(body.current_thread.links,
                             .href_url.domain.sld != sender.email.domain.sld
                      ),
                      .href_url.domain.sld
             )
  ) == 1
  // the link ...
  and any(body.current_thread.links,
          // display text is contained in the subject
          strings.icontains(.display_text, subject.base)
          // path has sender elements in 
          and (
            strings.icontains(.href_url.path, sender.email.local_part)
            or strings.icontains(.href_url.path, sender.email.domain.sld)
          )
  )
attack_types:
  - "Credential Phishing"
  - "BEC/Fraud"
tactics_and_techniques:
  - "Free file host"
  - "Free subdomain host"
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "Header analysis"
  - "URL analysis"
  - "Sender analysis"
id: "4f1b23f7-65e9-580c-bde4-b7f2b780af01"
