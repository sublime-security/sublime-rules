name: "Microsoft infrastructure abuse with suspicious patterns"
description: "Attackers have been observed abusing Microsoft's services, with suspicious indicators such as default Microsoft 365 domains (onmicrosoft.com), non-Microsoft return paths, or Resent-From headers. "
type: "rule"
severity: "high"
source: |
  type.inbound
  and sender.email.domain.root_domain == "microsoft.com"
  and headers.return_path.domain.domain not in $org_domains
  and 1 of (
    (
      length(recipients.to) == 1
      and all(recipients.to,
              .email.domain.root_domain == "onmicrosoft.com"
              and not .email.domain.domain in $org_domains
      )
    ),
    headers.return_path.domain.root_domain not in~ (
      'microsoft.com',
      'microsoftstoreemail.com',
      'microsoftsupport.com',
      'office.com',
      'teams-events.com',
      'qualtrics-research.com',
      'pb-dynmktg.com'
    ),
    any(headers.hops, any(.fields, .name == "Resent-From")),
    sender.email.local_part == "invites"
  )
  and 1 of (
    any([
          "CloudSync",
          "CloudVault",
          "Microsoft Subscription Team",
          "Advanced Suite Services",
          "TenantHub",
          "Unified Workspace Team",
          "18052948531",
          "MSFT-41713781",
          "1 805-294-8531",
          "(812) 223 8395",
          "Your Microsoft subscription has been renewed"
        ],
        strings.icontains(body.current_thread.text, .)
    ),
    // phone number regex
    any([body.current_thread.text, subject.subject],
        regex.icontains(.,
                        '\+?([ilo0-9]{1}.)?\(?[ilo0-9]{3}?\)?.[ilo0-9]{3}.?[ilo0-9]{4}',
                        '\+?([ilo0-9]{1,2})?\s?\(?\d{3}\)?[\s\.\-⋅]{0,5}[ilo0-9]{3}[\s\.\-⋅]{0,5}[ilo0-9]{4}'
        )
    ),
    // If one of the auth headers fail and logo_detect says Microsoft == bad mkay
    1 of (
      not headers.auth_summary.spf.pass,
      not headers.auth_summary.dmarc.pass,
      not "pass" in~ distinct(map(headers.hops, .authentication_results.dkim))
    )
    and any(ml.logo_detect(file.message_screenshot()).brands,
            strings.starts_with(.name, "Microsoft")
    )
  )
attack_types:
  - "BEC/Fraud"
  - "Callback Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
  - "Content analysis"
  - "Natural Language Understanding"
id: "c04ef82b-5e15-5763-a698-5d356897e5e5"
og_id: "cfe8e804-39ec-546f-9144-f721b95d9df1"
testing_pr: 3567
testing_sha: b90f6286c7b3b71c2d9de9f5875897b1342746c5