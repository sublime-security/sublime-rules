name: "Link: URL-encoded parameter with recipient email"
description: "Detects phishing attempts where the URL contains URL-encoded parameters that include the recipient's email address, often used to create personalized phishing pages."
type: "rule"
severity: "high"
source: |
  type.inbound
  and 0 < length(body.links) < 100
  
  // negate high trust sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
  and (
    not profile.by_sender().solicited
    or (
      profile.by_sender().any_messages_malicious_or_spam
      and not profile.by_sender().any_false_positives
    )
  )
  
  and not profile.by_sender().any_false_positives
  
  // Check for encoded URL parameters containing the recipient's email
  and any(recipients.to, 
    any(body.links, 
      (
        // Look for any form of the recipient's email in URL-encoded parameters
        // Check for regular presence
        strings.icontains(.href_url.query_params, .email.email)
        // Check for URL-encoded form (replacing @ with %40)
        or strings.icontains(.href_url.query_params, strings.replace(.email.email, "@", "%40"))
        // Check for URL-encoded hash fragment
        or strings.icontains(.href_url.url, strings.concat("%23%23", .email.email))
        or strings.icontains(.href_url.url, strings.concat("%23%23", strings.replace(.email.email, "@", "%40")))
      )
      and (
        // Additional risk indicators
        // Encoded URL parameters
        regex.match(.href_url.query_params, "(?:%[0-9a-fA-F]{2}){10,}")
        // URL redirectors or URL shorteners
        or any(
          [
            "url=", "u=", "redirect=", "link=", "goto=", "clickthrough=", 
            "navigate=", "clickid=", "redir=", "r=", "target="
          ],
          strings.icontains(.href_url.query_params, .)
        )
      )
    )
  )

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Impersonation: Brand"
detection_methods:
  - "URL analysis"