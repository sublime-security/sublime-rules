name: "PR# 4031 - Attachment: HTML smuggling Microsoft sign in"
description: |
  Scans HTML files to detect HTML smuggling techniques impersonating a Microsoft login page.
type: "rule"
severity: "high"
source: |
  type.inbound
  and any(attachments,
          (
            .file_extension in~ ("html", "htm", "shtml", "dhtml")
            or .file_extension in~ $file_extensions_common_archives
            or .file_type == "html"
          )
          and any(file.explode(.),
                  .scan.entropy.entropy >= 5.7
                  and .flavors.mime == "text/html"
                  and length(.scan.javascript.identifiers) == 0
                  and any(.scan.url.urls,
                          .domain.domain not in $tranco_1m
                          or .domain.root_domain in $free_subdomain_hosts
                  )
  
                  // seen in the wild: "sign in to your account", "sign in to your microsoft account"
                  and strings.ilike(.scan.html.title, "*sign in*", "*microsoft*")
          )
  )
  // allow Microsoft domains just to be safe
  and sender.email.domain.root_domain not in~ (
    'microsoft.com',
    'microsoftsupport.com',
    'office.com'
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Free subdomain host"
  - "HTML smuggling"
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Archive analysis"
  - "Content analysis"
  - "File analysis"
  - "Header analysis"
  - "Javascript analysis"
  - "Sender analysis"
  - "URL analysis"
id: "230ef493-624b-55eb-a068-0f29a3c51e00"
tags:
  - created_from_open_prs
  - rule_status_modified
  - pr_author_MSAdministrator
references:
  - https://github.com/sublime-security/sublime-rules/pull/4031