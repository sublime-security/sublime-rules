name: "Suspected cross-site scripting (XSS) found in subject"
description: "This rule detects Cross-Site Scripting (XSS) attempts within email subjects. It bypasses messages from highly trusted domains unless they fail authentication. However, the rule remains flexible, triggering even for trusted domains when emails are sent from Google Groups, ensuring thorough protection against potential threats while minimizing false positives."
type: "rule"
severity: "medium"
source: |
  type.inbound
  // subject contains suspected cross site scripting
  and regex.icontains(subject.subject,
                      '(?:[<]|%3c|%253c|\\u003c|\\x3c|&[lg]t;|&n[vw][lg]t;)\/?(?:script(?:\s*/?\s*src\s*=)?|iframe|embed|object|style|form|meta|link|svg|img|audio|video|source|body|input|textarea|select|noscript|div|html|/?title|/?textarea|/?style|/?template|/?noembed)',
                      // constructor chain pattern
                      'constructor\.constructor|\[\s*constructor\s*\]|\.__proto__|\[constructor\]'
  )
  
  // and contains html or url encoded strings, hex escaped strings, opening or closing html tags, or escaped non word characters
  and // subject contains common event handlers
   regex.icontains(subject.subject,
                   // Extended event handlers - removed word boundaries to catch encoded versions
                   'on\w+(?:%3D|=)',
                   // subject contains javascript functions and protocols
                   '\b(?:javascript|eval|settimeout|setinterval|document\.(?:cookie|write|location|createElement|body|appendChild)|fetch|constructor|__proto__|prototype|\.getScript|import|atob|Function)\b',
                   // JavaScript protocol
                   'javascript:',
                   // XSS testing domains
                   'xss\.report|xsshunter|ezxss|bxss\.me|xss0r\.com',
                   // Case-insensitive HTML elements for encoded versions
                   '(?i)iframe|(?i)srcdoc|(?i)div'
  )
  and regex.icontains(subject.subject,
                      // Pattern 1: Quote followed by various special characters in encoded/literal forms:
                      // - < > angle brackets (%3C, %3E, literal, &lt;, &gt;)
                      // - quotes (&quot;, &apos;)
                      // - parentheses (&lpar;, &rpar;)
                      // - curly braces (&lcub;, &rcub;)
                      // - square brackets (&lsqb;, &rsqb;)
                      // - equals sign (&equals;)
                      // - forward/backward slashes (&sol;, &bsol;)
                      // - colon (&colon;)
                      // - semicolon (&semi;)
                      '[\x27\x22](?:%3[CE]|%253[CE]|[<>]|&(?:lt|gt|quot|apos|[lr](?:par|cub|sqb)|equals|[bs]ol|colon|semi)\x3b)',
                      // Pattern 2: Encoded/special characters followed by quote
                      '(?:%3[CE]|%253[CE]|[<>]|&(?:lt|gt|quot|apos|[lr](?:par|cub|sqb)|equals|[bs]ol|colon|semi)\x3b)[\x27\x22]',
                      // Pattern 3: Hexadecimal or decimal HTML entities with semicolon
                      '&#[xX]?[a-f0-9]+;',
                      // Pattern 4: Raw decimal HTML entities
                      '&#\d+',
                      // Pattern 5: URL encoded characters (single and double encoding)
                      '%[a-f0-9]{2}|%25[a-f0-9]{2}',
                      // Pattern 6: Unicode/hex escapes
                      '\\[xXuU][a-f0-9]{4}',
                      // Pattern 7: Closing tags with slash delimiters
                      '</[^>]+/[^>]+>',
                      // Pattern 8: Protocol-relative URLs
                      '//[^"\x27>\s]+',
                      // Pattern 9: XSS domains
                      'xss\.report|xss0r\.com',
                      // Pattern 10: Comment chars
                      '/\*|\*/|\-\->',
                      // Pattern 11: Double URL encoding patterns
                      '%25[23][0-9A-Fa-f]'
  )
  
  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and (
        any(distinct(headers.hops, .authentication_results.dmarc is not null),
            strings.ilike(.authentication_results.dmarc, "*fail")
        )
        or (
          strings.icontains(sender.display_name, "via")
          and any(headers.hops,
                  any(.fields,
                      .name == "List-ID"
                      and strings.ends_with(.value,
                                            strings.concat(sender.email.domain.domain,
                                                           ">"
                                            )
                      )
                  )
          )
        )
      )
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Scripting"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
id: "db0b9bbe-798f-5cee-bf30-ed00ff41a3f6"
og_id: "8a946cfa-58ea-59c5-9726-94a1892b5556"
testing_pr: 3159
testing_sha: 4e1fcb99c5d669a218c4c3d12bce4264fb27e39d