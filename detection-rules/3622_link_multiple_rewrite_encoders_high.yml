name: "Link: Many URL rewrite encoders"
description: "Detects URLs with many encoding patterns, including multiple instances of the same encoder or four or more distinct encoders. These techniques are commonly used to obfuscate malicious URLs and evade security filters."
type: "rule"
severity: "high"
source: |
  type.inbound
  and 1 of (
    any(filter(body.links,
               .href_url.domain.root_domain not in $high_trust_sender_root_domains
               or .href_url.domain.root_domain not in $tranco_10k
        ),
        1 of (
          // 3 or more encoders but they are all the same ones
          length(.href_url.rewrite.encoders) >= 3
          and length(distinct(.href_url.rewrite.encoders)) == 1,
          // 4 or more encoders but they are all distinct
          length(.href_url.rewrite.encoders) >= 4
          and length(distinct(.href_url.rewrite.encoders)) >= 4,
        )
    ),
    any(attachments,
        any(file.explode(.),
            any(filter(.scan.url.urls,
                       .domain.root_domain not in $high_trust_sender_root_domains
                       or .domain.root_domain not in $tranco_10k
                ),
                1 of (
                  // 3 or more encoders but they are all the same ones
                  length(.rewrite.encoders) >= 3
                  and length(distinct(.rewrite.encoders)) == 1,
                  // 4 or more encoders but they are all distinct
                  length(.rewrite.encoders) >= 4
                  and length(distinct(.rewrite.encoders)) >= 4,
                )
            )
        )
    )
  )
attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Encryption"
  - "Evasion"
detection_methods:
  - "URL analysis"
  - "Content analysis"
  - "Archive analysis"
  - "File analysis"
id: "4cbb2de6-ba75-5a24-8bc0-bfaf0c6925d2"
og_id: "b88e53a7-9947-5c6b-bea9-d67906634655"
testing_pr: 3622
testing_sha: 2839b4b0a8881f87f184738ce92c841ce9044f03