name: "Google Classroom Spoofing With WhatsApp Contact Information"
description: "Detects messages impersonating Google Classroom notifications that contain WhatsApp contact information, likely attempting to redirect victims to out-of-band communication channels for social engineering attacks."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and sender.email.email == "no-reply@classroom.google.com"
  and (
    // check for a whatsapp invitation in the currend_thread
    (
      regex.icontains(body.current_thread.text, '\bWhatsapp:?.[:0-9+ ]{7,20}\b')
      or (
        strings.icontains(body.current_thread.text, "WhatsApp")
        and strings.icontains(body.current_thread.text, "invited")
      )
    )
    // check for whatsapp invitation within the OCR of an attachment. 
    or any(file.explode(beta.message_screenshot()),
      regex.icontains(.scan.ocr.raw,
        // International format with OCR-friendly character classes
        '\+?[ilo0-9]{1,3}[\s\.\-⋅]?\(?[ilo0-9]{3}\)?[\s\.\-⋅]{0,3}[ilo0-9]{3}[\s\.\-⋅]{0,3}[ilo0-9]{3,4}',
        // US format
        '\(?[ilo0-9]{3}\)?[\s\.\-⋅]{0,3}[ilo0-9]{3}[\s\.\-⋅]{0,3}[ilo0-9]{4}',
        // WhatsApp-specific format
        '[Ww]hats[Aa]pp:?[\s]*[+]?[ilo0-9\s\.\-⋅\(\)]{10,18}'
      )
      or regex.icontains(.scan.ocr.raw, '[Ww]hats[Aa]pp|[Ww]hatsapp')
    )
  )

attack_types:
  - "Callback Phishing"
  - "BEC/Fraud"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Out of band pivot"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Sender analysis"
id: "8e931efb-2d86-58b6-ae0e-2a7c1fd11c97"
og_id: "e9c39e92-4817-535a-91f9-13ad68885ff9"
testing_pr: 3094
testing_sha: 708948a682ef07c4870ff7d8460a3a7946d946e4