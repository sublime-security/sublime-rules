name: "VIP spoofing: Contact information in body without reply chain"
description: "Detects messages containing VIP contact information (name and email address) in the body content without proper email thread references, indicating potential impersonation of organizational VIPs."
type: "rule"
severity: "high"
source: |
  type.inbound
  and sender.email.domain.root_domain not in $high_trust_sender_root_domains
  and (
      coalesce(headers.auth_summary.dmarc.pass, false) 
      and coalesce(headers.auth_summary.spf.pass, false)
      and not 'fail' in~ distinct(map(headers.hops, .authentication_results.dkim))
  )
  and (length(headers.references) == 0 or headers.in_reply_to is null)
  and any($org_vips,
          strings.icontains(body.html.raw, strings.concat(.display_name, " <"))
          or strings.icontains(body.html.raw, strings.concat("<", .email, ">"))
          or strings.icontains(body.current_thread.text,
                               strings.concat(.display_name, " <")
          )
          or strings.icontains(body.current_thread.text,
                               strings.concat("<", .email, ">")
          )
          or strings.icontains(body.plain.raw,
                               strings.concat(.display_name, " <")
          )
          or strings.icontains(body.plain.raw, strings.concat("<", .email, ">")),
  )
tags:
  - "Attack surface reduction"
attack_types:
  - "BEC/Fraud"
tactics_and_techniques:
  - "Impersonation: VIP"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Header analysis"
id: "736d71cc-7415-55da-b13c-05fa4d027f9c"
