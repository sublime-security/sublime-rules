name: "Link: Payment view with mismatched registrar in fake thread"
description: "Detects messages claiming to be replies but lacking previous thread context, containing links with 'view payment' text where the sender and link domains are registered by different entities."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and headers.in_reply_to is not null
  and not subject.is_forward
  and length(body.previous_threads) == 0
  and any(filter(body.links,
                 .href_url.domain.root_domain != sender.email.domain.root_domain
          ),
          network.whois(sender.email.domain).registrar_name != network.whois(.href_url.domain
          ).registrar_name
          and (strings.icontains(.display_text, 'view payment'))
  )

attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Spoofing"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Sender analysis"
  - "URL analysis"
  - "Whois"
