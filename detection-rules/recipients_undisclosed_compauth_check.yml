name: "Suspicious Recipients pattern with no Compauth pass"
description: "Detects messages with undisclosed recipients (likely all bcc) and Compauth verdict is not 'pass'"
type: "rule"
severity: "medium"
source: |
  type.inbound
  and (
      length(recipients.to) == 0
      or all(recipients.to, .display_name == "Undisclosed recipients")
  )
  and length(recipients.cc) == 0
  and length(recipients.bcc) == 0
  and (
      any(headers.hops,
          .authentication_results.compauth.verdict is not null
          and .authentication_results.compauth.verdict != "pass"
      )
  )
tags:
  - "Suspicious sender"
  - "Suspicious headers"
