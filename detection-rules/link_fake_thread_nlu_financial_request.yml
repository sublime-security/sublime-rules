name: "Link: Fake message thread with suspicious links and NLU financial request"
description: "Detects fake message threads with suspicious links and financial request language"
type: "rule"
source: |
  type.inbound 

  // mailer is not null
  and headers.mailer is not null

  // fake thread check
  and strings.istarts_with(subject.subject, "RE:")

  // Check for the Presence of References or In-Reply-To properties
  and (
      length(headers.references) == 0
      or not any(headers.hops, any(.fields, strings.ilike(.name, "In-Reply-To")))
  )

  // sender's domain is not in body, and body has > 0 links
  and length(body.links) > 0
  and sender.email.domain.root_domain not in $free_email_providers
  and not any(body.links, .href_url.domain.root_domain == sender.email.domain.root_domain)

  // unusual sender (email address rarely sends to your organization)
  and sender.email.email not in $sender_emails

  // unusual sender domain (domain rarely sends to your organization)
  and sender.email.domain.domain not in $sender_domains

  // language attempting to engage
  and any(ml.nlu_classifier(body.html.inner_text).entities, .name == "request")

  // financial request
  and any(ml.nlu_classifier(body.html.inner_text).entities, .name == "financial")
severity: "medium"
tags:
  - "Suspicious link"
  - "Fake Message Thread"
  - "Natural Language Understading"
  - "Machine Learning"
