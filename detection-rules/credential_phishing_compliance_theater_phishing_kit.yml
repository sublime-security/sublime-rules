name: "Credential Phishing: ComplianceTheater Phishing Kit"
description: "Detects messages containing links with specific display text patterns, path structures, or query parameters that correlate with Microsoft HTML comments, indicating potential brand impersonation tactics."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and any(filter(body.links,
                 (
                   regex.icontains(.display_text, "Q[0-9]_20[0-9.]")
                   and (
                     strings.starts_with(.href_url.path,
                                         strings.concat("/",
                                                        sender.email.domain.sld
                                         )
                     )
                     or strings.icontains(.href_url.path,
                                          strings.concat(sender.email.domain.sld,
                                                         ".html"
                                          )
                     )
                     or strings.count(body.html.raw, "revert !important") > 300
                   )
                 )
                 // a PDF link with the actual url ending in .html
                 or (
                   strings.ends_with(.display_text, ".pdf")
                   and strings.ends_with(.href_url.path, ".html")
                 )
                 //  these query_params
                 or (
                   strings.icontains(.href_url.query_params, "id-")
                   and strings.icontains(.href_url.query_params, ".key-")
                   and strings.icontains(.href_url.query_params, ".token-")
                 )
          ),
          length(filter(html.xpath(ml.link_analysis(., mode="aggressive").final_dom,
                                   "//comment()"
                        ).nodes,
                        strings.starts_with(.raw, "<!-- Microsoft ")
                 )
          ) >= 4
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Impersonation: Brand"
detection_methods:
  - "Content analysis"
  - "HTML analysis"
  - "URL analysis"
id: "1150c5b2-3a51-53c8-9c89-6bb9a41dc2f7"
