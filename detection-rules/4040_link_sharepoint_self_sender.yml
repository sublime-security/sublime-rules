name: "PR# 4040 - Link: SharePoint OneNote or PDF link with self sender behavior"
description: "Detects messages where the sender and recipient are the same address, containing SharePoint links to OneNote or PDF files, with minimal attachments and non-standard message IDs indicating potential abuse of SharePoint services for malicious purposes."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and any(filter(body.links, .href_url.domain.root_domain == 'sharepoint.com'),
          // it is either a OneNote or PDF file, or unknown
          regex.icontains(.href_url.path, '\/:[obu]:\/(?:p|g\/personal)')
  )
  and not strings.starts_with(headers.message_id, '<Share-')
  and not strings.ends_with(headers.message_id, '@odspnotify>')
  and length(recipients.to) == 1
  and recipients.to[0].email.email == sender.email.email
  // 0 or 1 attachments (this resudces FPs whcich had many attachments)
  and length(attachments) - length(filter(attachments,
                                          strings.contains(body.html.raw,
                                                           strings.concat('src="cid:',
                                                                          .content_id
                                                           )
                                          )
                                   )
  ) <= 1
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Free file host"
  - "OneNote"
  - "PDF"
detection_methods:
  - "Header analysis"
  - "URL analysis"
  - "Sender analysis"
id: "07ba6eb7-19eb-591e-bafb-3156d418a1e6"
tags:
  - created_from_open_prs
  - rule_status_added
  - pr_author_zoomequipd
references:
  - https://github.com/sublime-security/sublime-rules/pull/4040