name: "AppSheet infrastructure abuse"
description: "Identifies messages that resemble credential theft, originating from AppSheet. AppSheet infrastrcture abuse has been observed recently to send phishing attacks."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and sender.email.email == "noreply@appsheet.com"
  and (
    // name of the org or user present in subject
    (
      any($org_display_names, strings.contains(subject.base, .))
      or any($org_slds, strings.contains(subject.base, .))
    )
    // recently registered or suspicious links
    or (
      any(filter(body.links, .href_url.domain.root_domain != "appsheet.com"),
          network.whois(.href_url.domain).days_old <= 10
          or .href_url.domain.root_domain in $free_file_hosts
          or .href_url.domain.domain in $free_subdomain_hosts
          or .href_url.domain.root_domain in $url_shorteners
          // account for URL rewrites
          or (
            any(.href_url.query_params_decoded['domain'],
                (
                  . in $url_shorteners
                  or . in $free_subdomain_hosts
                  or . in $free_file_hosts
                )
            )
          )
      )
    )
    // suspicious display name
    or (
      regex.icontains(sender.display_name,
                      '(?:legal|misuse|compliance|violation|enforcement)',
                      // unicode blank character confusables in display name
                      '\x{00A0}|\x{1680}|\x{2000}|\x{200A}|\x{200B}|\x{202F}|\x{205F}|\x{3000}'
      )
      // commonly impersonated brands
      or strings.ilike(strings.replace_confusables(sender.display_name),
                       '*Apple*',
                       '*Amazon*',
                       '*Binance*',
                       '*Facebook*',
                       '*Meta*',
                       '*Google*',
                       '*LinkedIn*'
      )
    )
    // suspicious pattern in body
    or regex.icontains(body.current_thread.text,
                       '(?:(Copyright|Advertising|Content|Data|Intellectual Property|I\.?\s?P\.?\b) (?:Polic(y|ies))|Violation|Contravention|Complaint|Misuse)|(?:(Enforce(ment)?|Required|Mandatory|Immediate) (?:Action|Response))|Cease (\&|and) Desist'
    )
    // NLU failsafe
    or (
      any(ml.nlu_classifier(body.current_thread.text).intents,
          .name in~ ("cred_theft", "steal_pii", "job_scam")
          and .confidence in~ ("medium", "high")
      )
      // negate the NLU result if there is only a single link leading back to AppSheet (likely benign)
      and not (
        length(body.links) == 1
        and any(body.links,
                .display_text == "Powered by AppSheet"
                and .href_url.domain.root_domain == "appsheet.com"
        )
      )
    )
  )

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Natural Language Understanding"
  - "URL analysis"
  - "Whois"
id: "f98ce82b-487c-5669-aaca-31a651a96bb3"
og_id: "5937646a-60b0-5b86-9df0-94c8d18aa774"
testing_pr: 3207
testing_sha: 13fabc85d02ad3713ac26ade1c1c569ea7ca0682