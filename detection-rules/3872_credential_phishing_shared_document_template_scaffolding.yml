name: "PR# 3872 - Credential phishing: Shared document template with characteristic HTML scaffolding"
description: |
  Detects phishing emails using a specific HTML template structure commonly used for fake
  document sharing notifications. Identifies the template by its characteristic color scheme,
  layout patterns, and structural elements including the light band section with Item/Type fields,
  blue CTA button, and security notice.
type: "rule"
severity: "high"
source: |
  type.inbound
  and length(body.links) > 0
  // characteristic HTML structure with specific color scheme and layout
  and (
    // outer table with specific background color #f3f4f6 (gray background)
    strings.icontains(body.html.raw, 'bgcolor="#f3f4f6"')
  
    // nested table with white background and specific styling
    and regex.icontains(body.html.raw,
                        '<table[^>]*max-width:640px[^>]*background:#ffffff'
    )
    and strings.icontains(body.html.raw, 'border-radius:8px')
  
    // light band section with specific background #f9fafb
    and strings.icontains(body.html.raw, 'bgcolor="#f9fafb"')
  
    // blue CTA button with specific background color #2563eb (display:inline-block comes before background)
    and regex.icontains(body.html.raw,
                        '<a[^>]*display:inline-block[^>]*background:#2563eb'
    )
  )
  
  // characteristic content patterns
  and (
    // "Item:" and "Type:" field labels in the light band section
    (
      strings.icontains(body.html.raw, "<strong>Item:</strong>")
      and strings.icontains(body.html.raw, "<strong>Type:</strong>")
    )
  
    // document sharing language
    and strings.ilike(body.current_thread.text,
                      "*document*shared*",
                      "*shared*document*",
                      "*has shared a copy*"
    )
  
    // security/privacy notice (common in this template)
    and strings.ilike(body.current_thread.text,
                      "*link is unique to you*",
                      "*do not forward this email*",
                      "*do not share the link*"
    )
  )
  
  // specific color palette used in this template (multiple matches increase confidence)
  and (
    3 of (
      // outer background gray
      strings.icontains(body.html.raw, "#f3f4f6"),
      // border color light gray
      strings.icontains(body.html.raw, "#e5e7eb"),
      // light band background
      strings.icontains(body.html.raw, "#f9fafb"),
      // blue CTA button
      strings.icontains(body.html.raw, "#2563eb"),
      // dark text color
      strings.icontains(body.html.raw, "#111827"),
      // medium gray text
      strings.icontains(body.html.raw, "#6b7280")
    )
  )
  
  // exclude automated notifications from known services
  and not (
    any(headers.domains,
        .root_domain in (
          "docusign.com",
          "docusign.net",
          "box.com",
          "dropbox.com",
          "sharepoint.com",
          "onedrive.com"
        )
    )
    and coalesce(headers.auth_summary.spf.pass, false)
  )
tags:
  - "Attack surface reduction"
  - "Credential Phishing"
  - "HTML analysis"
  - pr_author_IndiaAce
  - created_from_open_prs
  - rule_status_added
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "HTML analysis"
  - "Natural Language Understanding"
id: "dfd1809b-a84b-5068-8e85-64d9fcca0be5"
references:
  - https://github.com/sublime-security/sublime-rules/pull/3872