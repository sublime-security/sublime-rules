name: "Attachment: ICS calendar with suspicious Microsoft location"
description: "Calendar attachment contains location field with Microsoft-related terms or admin portal references that don't match legitimate Microsoft Teams meeting patterns.

We've identified that Impact PhaaS is using this technique but it not neccessarily the only one."
type: "rule"
severity: "high"
source: |
  type.inbound
  and (
    // attached EMLs with html/svg attachments
    // we've identified that Impact PhaaS is using this technique
    any(filter(attachments, .content_type == "text/calendar"),
        any(beta.file.parse_ics(.).events,
            (
              strings.icontains(.location, "microsoft")
              or strings.icontains(.location, "admin portal")
              or regex.imatch(.location, 'admin[\s_]portal')
              or strings.icontains(.location, "attached portal")
            )
            and not (
              .location in~ (
                // english
                "microsoft teams meeting",
                // translate says english but looks portguese
                "Riunione Microsoft Teams",
                // portuguese
                "Reunião do Microsoft Teams",
                // portuguese
                "Reuniões do Microsoft Teams",
                // spanish
                "Reunión de Microsoft Teams",
                // danish
                "Microsoft Teams-møde",
                // japanese
                "Microsoft Teams 会議",
                // german
                "Microsoft Teams-Besprechung",
                // chinese
                "Microsoft Teams 会议",
                "Microsoft Teams 會議",
                // czech
                "Schůzka v Microsoft Teams",
                // french
                "Réunion Microsoft Teams",
  
                // additional fp values
                "Microsoft Teams Meeting; Capitol Conference Room",
                "Microsoft Teams Meeting; The Globe",
                "Virtual (Microsoft Teams Meeting)",
                "Microsoft Teams Meeting; The Factory",
                "Microsoft Teams Meeting; MERCURY",
              )
              or strings.icontains(.location, "microsoft team meeting")
            )
        )
    )
  )
attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "File analysis"
id: "13acf93f-94cf-5c47-b492-1857c78cda16"
og_id: "996d7a81-6d57-585f-bb28-2d934eaed5a5"
testing_pr: 3822
testing_sha: daba6294264974d3f4a93eb5c0f5c1459e2c8e3d