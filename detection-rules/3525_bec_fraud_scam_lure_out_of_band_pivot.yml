name: "BEC/Fraud: Scam lure with freemail pivot"
description: "This message detects BEC/Fraud lures attempting to solicit the victim to pivot out of band via a freemail address in the body."
type: "rule"
severity: "low"
source: |
  type.inbound
  
  // body is short
  and length(body.current_thread.text) < 800
  
  // one recipient
  and length(recipients.to) == 1
  
  // not an org domain
  and all(recipients.to,
          .email.domain.root_domain not in $org_domains
          and (
            .email.domain.valid or strings.icontains(.display_name, "undisclosed")
          )
  )
  
  // one link
  and length(filter(body.links, .href_url.domain.root_domain != "aka.ms")) == 1
  
  // links don't match sender
  and all(body.links,
          .href_url.domain.root_domain != sender.email.domain.root_domain
  )
  
  // scam indicators
  and regex.icontains(body.current_thread.text,
                      '((?:Mr|Mrs|Ms|Miss|Dr|Prof|Sir|Lady|Rev)\.?[ \t]+)|(sir|madam|kindly)|(dringend|eingefordert|anspruch)'
  )
  
  // body contains an email address to a freemail provider
  and (
    regex.contains(body.current_thread.text,
                   "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"
    )
    and (
      any($free_email_providers, strings.icontains(body.current_thread.text, .))
      or (
        any(regex.extract(body.current_thread.text,
                          "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"
            ),
            any(network.whois(strings.parse_email(.full_match).domain).name_servers,
                .root_domain in $parked_domain_nameservers
            )
        )
      )
    )
  )
  
  // new and unsolicited and no malicious or FP's
  and (
    (
      profile.by_sender().prevalence in ("new", "outlier")
      and not profile.by_sender().solicited
    )
    or (
      profile.by_sender().any_messages_malicious_or_spam
      and not profile.by_sender().any_messages_benign
    )
  )
  and not profile.by_sender().any_messages_benign
attack_types:
  - "BEC/Fraud"
tactics_and_techniques:
  - "Free email provider"
  - "Out of band pivot"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "Sender analysis"
id: "e55001a8-e7fd-5dda-97ec-794f6794db32"
og_id: "898c769f-45a4-5561-8d51-be765addcf1d"
testing_pr: 3525
testing_sha: fb8b72e20e957b2f9db7b0ba5d05faa879cd1496