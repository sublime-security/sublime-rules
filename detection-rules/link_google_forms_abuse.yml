name: "Link: Google Forms abuse"
description: "Detects Google Forms links with suspicious display text containing credential theft keywords, or form fields requesting password information."
type: "rule"
severity: "high"
source: |
  type.inbound
  and length(attachments) == 0
  and any(filter(body.links, .href_url.domain.domain == "forms.gle"),
          // avoid invoking Link Analysis if the display-text has strong indications of phishing
          (
            regex.icontains(strings.replace_confusables(.display_text),
                            'review|proposal|document|efax|restore|\b[o0]pen\b|secure|messaging|reset|account|verify|login|notification|alert|urgent|immediate|access|support|\bupdate\b|download|attachment|service|payment|remittance|invoice'
            )
            // add confidence to these strings by using profile.by_sender()
            and (
              not profile.by_sender().solicited
              and profile.by_sender().prevalence in ('new', 'outlier')
            )
            and not (
              // negate replies and forwards
              (
                length(headers.references) > 0
                or any(headers.hops,
                       any(.fields, strings.ilike(.name, "In-Reply-To"))
                )
              )
              // negate listservs
              or (
                any(headers.hops, any(.fields, .name == "List-Unsubscribe"))
                and (
                  strings.contains(sender.display_name, "via")
                  or strings.icontains(subject.subject, "monitor")
                  or any(recipients.to, strings.icontains(.display_name, 'list'))
                )
              )
            )
          )
          or 
          // invoke Link Analysis to look at the final_dom
          // if the page has been taken down, match
          strings.icontains(ml.link_analysis(., mode="aggressive").final_dom.inner_text,
                            "You can't access this item because it is in violation"
          )
          or 
          // credential phishing indicators in form fields
          any(html.xpath(ml.link_analysis(., mode="aggressive").final_dom,
                         "/html/body/div//form/div[2]/div/div[2]/div"
              ).nodes,
              // match any variation of the word "password" in data-params tags
              // legitimate forms should never ask the user to input credentials, there is a disclaimer to that effect
              regex.icontains(.raw,
                              'data-params=\".*(p[a@][s$]{2}(w[o0]rd|\*{1,4})).*\"'
              )
          )
  )

attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "HTML analysis"
  - "Sender analysis"
  - "URL analysis"
  - "URL screenshot"
