name: "Attachment: Office file with document sharing and browser instruction lures"
description: "Detects macro-enabled attachments containing document sharing language (sent, shared, forwarded) combined with browser interaction instructions (copy, right-click) or common email disclaimers. These tactics are often used to trick users into enabling macros or following malicious instructions."
type: "rule"
severity: "high"
source: |
  type.inbound
  and any(filter(attachments,
                 .file_extension in $file_extensions_macros
                 // limit the size to reduce FPs, the larger the document, the more likely it is for FPs on benign automated reports
                 and .size < 2000000
          ),
          // Detection Note: There are multiple regex patterns used in multiple places, it'll be important to keep them in sync
          any(file.explode(.),
              // document sharing lure
              any(.scan.strings.strings,
                  regex.icontains(.,
                                  '(?:sent|shared|forwarded|provided|invited|received)(?:\s+\w+){0,9}\s+(?:document|file|attachment)',
                  )
              )
              // ocr output
              or regex.icontains(.scan.ocr.raw,
                                 '(?:sent|shared|forwarded|provided|invited|received)(?:\s+\w+){0,9}\s+(?:document|file|attachment)',
              )
          )
          // copy/paste browser stuff
          and (
            any(file.explode(.),
                any(.scan.strings.strings,
                    regex.icontains(.,
                                    '(?:copy (?:and paste)?|right.?click)(?:\s+\w+\s*){0,9}browser', 
                                    'click(?:\s+\w+\s*){0,9}(above|below) to'

                    )
                // ocr output
                )
                or regex.icontains(.scan.ocr.raw,
                                   '(?:copy (?:and paste)?|right.?click)(?:\s+\w+\s*){0,9}browser',
                                   'click(?:\s+\w+\s*){0,9}(above|below) to'

                )
                or 5 of (
                  strings.icontains(.scan.ocr.raw,
                                    'confidential and intended solely'
                  ),
                  strings.icontains(.scan.ocr.raw,
                                    'intended solely for the use of'
                  ),
                  strings.icontains(.scan.ocr.raw, 'intended recipient'),
                  strings.icontains(.scan.ocr.raw, 'received this email in error'),
                  strings.icontains(.scan.ocr.raw,
                                    'notify the sender immediately'
                  ),
                  strings.icontains(.scan.ocr.raw, 'delete it from your system'),
                  strings.icontains(.scan.ocr.raw, 'delete the email from'),
                  strings.icontains(.scan.ocr.raw, 'virus-free'),
                  strings.icontains(.scan.ocr.raw, 'scan for viruses'),
                  strings.icontains(.scan.ocr.raw, 'legally binding agreement'),
                  strings.icontains(.scan.ocr.raw, 'informational purposes only'),
                  strings.icontains(.scan.ocr.raw,
                                    'any attachments are confidential'
                  ),
                  strings.icontains(.scan.ocr.raw, 'loss or damage arising'),
                  strings.icontains(.scan.ocr.raw, 'responsibility for any loss'),
                  strings.icontains(.scan.ocr.raw, 'unauthorised and prohibited'),
                  strings.icontains(.scan.ocr.raw, 'subject to legal privilege'),
                  strings.icontains(.scan.ocr.raw,
                                    'The information contained in or attached'
                  ),
                  strings.icontains(.scan.ocr.raw,
                                    'people to whom it is addressed'
                  )
                )
            )
          )
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "Archive analysis"
  - "File analysis"
  - "Macro analysis"
  - "Optical Character Recognition"
  - "Content analysis"
id: "fc4020fc-5c19-5d3d-9859-e396f4572317"
og_id: "b1250a4b-fd4d-5c52-af60-83800eedac10"
testing_pr: 3165
testing_sha: fa180921f286834d86cbe237c4591813cf7fdcd2