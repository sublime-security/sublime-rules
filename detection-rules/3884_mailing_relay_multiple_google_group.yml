name: "PR# 3884 - Headers: Mailing list relay with multiple X-BeenThere headers"
description: "Detects messages relayed through mailing lists or groups where the sender's domain matches the recipient's domain (self-addressed) or where an unrelated sender is relaying through a group, combined with multiple X-BeenThere headers indicating potential mailing list abuse or routing manipulation."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and (
    // self-addressed through group
    any(recipients.to, .email.domain.domain == sender.email.domain.domain)
    or 
    // unrelated sender relaying through group
    (
      any(recipients.to,
          .email.domain.domain == headers.return_path.domain.domain
      )
      and sender.email.domain.root_domain != headers.return_path.domain.root_domain
    )
  )
  and sum(map(headers.hops,
              length(filter(.fields, strings.starts_with(.name, "X-BeenThere")))
          )
  ) > 1
  and not sender.email.domain.root_domain in $sender_domains

attack_types:
  - "BEC/Fraud"
  - "Spam"
tactics_and_techniques:
  - "Evasion"
  - "Spoofing"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
id: "611c4d60-ab4b-5814-be5e-7262d4a614b2"
tags:
  - created_from_open_prs
  - rule_status_added
  - pr_author_IndiaAce
references:
  - https://github.com/sublime-security/sublime-rules/pull/3884