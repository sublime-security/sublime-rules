name: "Attachment: PDF/Microsoft Word polyglot file"
description: |
  Detects a PDF attachment that, when opened in Microsoft Word, contains a macro.
references:
  - "https://blog.didierstevens.com/2023/08/29/quickpost-analysis-of-pdf-activemime-polyglot-maldocs/"
type: "rule"
severity: "high"
source: |
  type.inbound
  and any(attachments,
          .file_type == "pdf"
          and any(file.explode(.),
              .scan.entropy.entropy >= 5
              and length(filter(.scan.strings.strings, regex.imatch(., '[0-9] [0-9] obj'))) > 2
              and length(filter(.scan.strings.strings, strings.ilike(., 'endobj'))) > 2
              and any(.scan.strings.strings, strings.ilike(., "stream"))
              and any(.scan.strings.strings, strings.ilike(., "endstream"))
          )
  )
attack_types:
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Evasion"
  - "Macros"
  - "PDF"
detection_methods:
  - "File analysis"
  - "Macro analysis"
