name: "Brand impersonation: Royal Canadian Mounted Police"
description: "Impersonation of the Royal Canadian Mounted Police, Canada's federal police force."
type: "rule"
severity: "high"
source: |
  type.inbound
  and (
    (
      strings.ilike(sender.display_name,
                    '*rcmp*',
                    '*royal canadian mounted police*'
      )
      or strings.ilevenshtein(sender.display_name,
                              'royal canadian mounted police'
      ) <= 2
      or strings.ilike(sender.email.domain.domain, '*rcmp*')
    )
    or (
      (
        strings.ilike(subject.subject, '*rcmp*', '*royal canadian mounted*')
        or strings.ilevenshtein(subject.subject, 'royal canadian mounted police') <= 2
      )
      and (
        any([body.current_thread.text, body.plain.raw],
            any(ml.nlu_classifier(.).entities,
                .name == "org"
                and .text in~ ("rcmp", "royal canadian mounted police")
            )
        )
        or any([body.current_thread.text, body.plain.raw],
               strings.ilike(., '*rcmp*', '*royal canadian mounted police*')
        )
      )
    )
  )
  and (
    (
      any([body.current_thread.text, body.plain.raw],
          any(ml.nlu_classifier(.).intents,
              .name in ("cred_theft", "callback_scam", "steal_pii", "bec")
          )
      )
      and any([body.current_thread.text, body.plain.raw],
              any(ml.nlu_classifier(.).entities,
                  .name in ("urgency", "financial", "request")
              )
      )
    )
    or (
      any(attachments,
          (
            (.file_type in ("html") or .file_extension in ("htm", "html"))
            and (
              any(ml.nlu_classifier(file.parse_html(.).display_text).intents,
                  .name in ("cred_theft", "callback_scam", "steal_pii", "bec")
              )
              and any(ml.nlu_classifier(file.parse_html(.).display_text).entities,
                      .name in ("urgency", "financial", "request")
              )
            )
          )
          or (
            (
              .file_type in ("pdf")
              or .file_extension in ("pdf")
              or .file_type in $file_types_images
            )
            and any(file.explode(.),
                    (
                      any(ml.nlu_classifier(.scan.ocr.raw).intents,
                          .name in (
                            "cred_theft",
                            "callback_scam",
                            "steal_pii",
                            "bec"
                          )
                      )
                      and any(ml.nlu_classifier(.scan.ocr.raw).entities,
                              .name in ("urgency", "financial", "request")
                      )
                    )
            )
          )
      )
    )
  )
  and sender.email.domain.root_domain not in~ ('canada.ca')
  and sender.email.email not in $recipient_emails

attack_types:
  - "Extortion"
tactics_and_techniques:
  - "Free email provider"
  - "Image as content"
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Computer Vision"
  - "Content analysis"
  - "File analysis"
  - "Natural Language Understanding"
  - "Optical Character Recognition"
  - "Sender analysis"
