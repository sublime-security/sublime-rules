name: "PR# 3866 - Attachment: QR code with recipient targeting and special characters"
description: "Detects messages with QR code in attachments containing special characters in the path that include the recipient's email address in either the URL path or fragment, potentially encoded in base64. The URLs have a simple path structure and may end with suspicious patterns."
type: "rule"
severity: "high"
source: |
  type.inbound
  and length(recipients.to) == 1
  and recipients.to[0].email.domain.valid
  and any(attachments,
          any(file.explode(.),
              (
                // a single path
                strings.count(.scan.qr.url.path, '/') == 2
                and (
                  strings.icontains(.scan.qr.url.path, '/$')
                  or strings.icontains(.scan.qr.url.path, '/*')
                )
                // subdomain should contain num{3}alpha or alphanum{3}
                and regex.icontains(.scan.qr.url.domain.subdomain,
                                    '^(?:[a-z]+[0-9]{3}|[0-9]{3}[a-z]+)$'
                )
                // url path should contain num{3}alpha or alphanum{3}
                and regex.icontains(.scan.qr.url.path,
                                    '\/(?:[a-z]+[0-9]{3}|[0-9]{3}[a-z]+)\/'
                )
              )
              or (
                // special char in the path
                (
                  strings.icontains(.scan.qr.url.path, '!')
                  or strings.icontains(.scan.qr.url.path, '@')
                )
                // a single path
                and strings.count(.scan.qr.url.path, '/') == 2
                and (
                  strings.icontains(.scan.qr.url.path, '/$')
                  or strings.icontains(.scan.qr.url.path, '/*')
                  // hex dollar sign
                  or strings.icontains(.scan.qr.url.path, '%24')
                  // hex star
                  or strings.icontains(.scan.qr.url.path, '%2A')
                )
                // ensure expected ordering
                and regex.icontains(.scan.qr.url.url, '[!@].*(?:[$*]|%2[A4])')
              )
              and (
                (
                  strings.icontains(.scan.qr.url.path,
                                    recipients.to[0].email.email
                  )
                  or strings.icontains(.scan.qr.url.fragment,
                                       recipients.to[0].email.email
                  )
                  or any(strings.scan_base64(.scan.qr.url.path,
                                             ignore_padding=true
                         ),
                         strings.icontains(., recipients.to[0].email.email)
                  )
                  or any(strings.scan_base64(.scan.qr.url.fragment,
                                             ignore_padding=true
                         ),
                         strings.icontains(., recipients.to[0].email.email)
                  )
                )
              )
          )
  )
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "QR code"
  - "Social engineering"
  - "Evasion"
detection_methods:
  - "File analysis"
  - "QR code analysis"
  - "URL analysis"
  - "Computer Vision"
id: "d37a3f2c-6e15-59eb-b6ce-4eccc730232c"
tags:
  - created_from_open_prs
  - rule_status_modified
  - pr_author_hadojae
references:
  - https://github.com/sublime-security/sublime-rules/pull/3866