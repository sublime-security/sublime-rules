name: "Reply-To is Freemail, sender is not"
type: "query"
description: "Sender is a custom domain, but reply-to is a freemail domain"
source: |
  map(filter(headers.reply_to,
    length(headers.reply_to) > 0
    and sender.email.email not in $free_email_providers
    and all(headers.reply_to, 
      .email.email != sender.email.email
      and .email.domain.domain in $free_email_providers
      and .email.email not in $sender_emails
     // and strings.contains(.email.local_part, sender.email.domain.sld)
    )
  ), .email.email)
severity: "medium"
tags:
  - "Suspicious headers"
