name: "Phriendly Phishing phishing simulation"
description: Reference ips from this article https://help.phriendlyphishing.com/hc/en-gb/articles/17114230929043-Whitelisting-Google-Workspace#h_01JZA9JQWE3SPAD2ZS7MG37SCH

type: "query"
source: |
  type.inbound
  and 1 of (
    // Phriendly Phishing ips
    any(headers.ips,
        .ip in (
          "54.153.200.195",
          "54.252.116.154",
          "52.63.70.98",
          "52.64.99.134",
          "35.176.5.2"
        )
    ),
    // Phriendly Phishing domains
    sender.email.domain.root_domain in~ (
      "phriendlyphishing.com",
      "phishingacademy.com",
      "phriendlyphishes.com",
      "phriendlyphishingtraining.com",
      "phriendlyphishingsupport.com",
      "phriendlyphishingapp.com"
    ),
    // Return-path domain check
    headers.return_path.domain.root_domain in~ (
      "phriendlyphishing.com",
      "phishingacademy.com",
      "phriendlyphishes.com",
      "phriendlyphishingtraining.com",
      "phriendlyphishingsupport.com",
      "phriendlyphishingapp.com"
    ),
    // Phriendly Phishing urls
    length(body.links) >= 1
    and any(body.links,
            .href_url.domain.domain in (
              "launch.phriendlyphishing.com",
              "mail.phishingacademy.com",
              "training.phriendlyphishing.com",
              "phriendlyphishing.com",
              "learnerhub.phriendlyphishing.com",
              "learnerhub.uk.phriendlyphishing.com",
              "phriendlyphishes.com",
              "phriendlyphishingtraining.com",
              "phriendlyphishingsupport.com"
            )
    ),
    // Phriendly Phishing urls in attachments
    length(attachments) >= 1
    and any(attachments,
            strings.icontains(file.parse_html(.).raw,
                              "launch.phriendlyphishing.com"
            )
    )
  )
  and headers.return_path.domain.sld == "phriendlyphishing"
severity: "informational"
tags:
  - "Headers"
  - "Phishing simulation"
