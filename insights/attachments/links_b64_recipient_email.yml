name: "Base64-encoded recipient email in attachment link"
type: "query"
source: |
  filter(map(attachments,
             map(file.explode(.),
                 distinct(map(filter(.scan.url.urls,
                                     any(recipients.to,
                                         .email.domain.valid
                                         and any(beta.scan_base64(..url,
                                                                  format="url",
                                                                  ignore_padding=true
                                                 ),
                                                 strings.icontains(.,
                                                                   ..email.email
                                                 )
                                         )
                                     )
                              ),
                              .url
                          ),
                          .
                 )
             )
         ),
         length(.) > 0
  )
severity: "high"
