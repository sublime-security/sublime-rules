name: "Links contain recipient email in attachments"
type: "query"
source: |
  filter(
    map(attachments,
        map(file.explode(.),
            distinct(map(filter(.scan.url.urls, any(recipients.to, strings.icontains(..url, .email.email))), .url), .)
        )
    ),
    length(.) > 0
  )
severity: "medium"
