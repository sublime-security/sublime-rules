name: "QR Code Link in an Attached EML's Attachments Contains Recipient Email Address"
type: "query"
source: |
  map(attachments,
      map(file.parse_eml(.).attachments,
          map(filter(file.explode(.),
                     .scan.qr.type == "url"
                     and (
                       any(file.parse_eml(...).recipients.to,
                           strings.contains(..scan.qr.url.url, .email.email)
                       )
                       or 
                       any(recipients.to,
                              strings.contains(..scan.qr.url.url, .email.email)
                       )
                     )
              ),
              .scan.qr.url.url
          )
      )
  )
severity: "high"
