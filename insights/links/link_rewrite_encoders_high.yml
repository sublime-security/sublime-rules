name: "Excessive URL rewrite encoders"
description: |
  Detects links that have been processed through many (excessive) URL rewrite encoders, which may indicate obfuscation or evasion techniques.
type: "query"
source: |
  type.inbound
  and (
    any(body.links,
        (
          // 3 or more encoders but they are all the same ones
          length(.href_url.rewrite.encoders) >= 3
          and length(distinct(.href_url.rewrite.encoders)) == 1
        )
        or (
          // 4 or more encoders but they are all distinct
          length(.href_url.rewrite.encoders) >= 4
          and length(distinct(.href_url.rewrite.encoders)) >= 4
        )
    )
    or (
      any(attachments,
          any(file.explode(.),
              any(.scan.url.urls,
                  (
                    // 3 or more encoders but they are all the same ones
                    length(.rewrite.encoders) >= 3
                    and length(distinct(.rewrite.encoders)) == 1
                  )
                  or (
                    // 4 or more encoders but they are all distinct
                    length(.rewrite.encoders) >= 4
                    and length(distinct(.rewrite.encoders)) >= 4
                  )
              )
          )
      )
    )
  )
severity: "high"
tags:
  - "Suspicious Link"
  - "Mismatched Link"
