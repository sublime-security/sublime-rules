name: "Current event: CrowdStrike impersonation"
description: "Discovery rule for messages which are leveraging the CrowdStrike defect generated on Jul 19th 2024 which caused wide spread outages. "
type: "rule"
severity: "low"
references:
  - "https://www.crowdstrike.com/blog/statement-on-falcon-content-update-for-windows-hosts/"
source: |
  type.inbound
  and (
    any([sender.display_name, subject.subject, body.current_thread.text],
        strings.icontains(., "crowdstrike")
    )
    or any(body.links, strings.icontains(.display_text, 'crowdstrike'))
  
    // look alike display_name
    or 0 < strings.ilevenshtein(strings.replace_confusables(sender.display_name), 'crowdstrike') <= 2
  
    // look alike domains
    or 0 < strings.ilevenshtein(strings.replace_confusables(sender.email.domain.sld), 'crowdstrike') <= 2
  )
  
  // has either attachments or links
  and sum([length(body.links), length(attachments)]) > 0
  
  // the links don't all go to crowdstrike or other "trusted" sites.
  and all(body.links,
          .href_url.domain.root_domain not in (
            'crowdstrike.com',
            'aka.ms',
            'mimecastprotect.com',
            'mimecast.com',
            'microsoft.com'
          )
  )
  
  // not from CS actual
  and not (
    sender.email.domain.root_domain == 'crowdstrike.com'
    and headers.auth_summary.dmarc.pass
    and headers.auth_summary.spf.pass
  
    and (
          // if there is a reply-to header, make sure the root_domain is crowdstrike
          (
              length(headers.reply_to) > 0 
              and all(headers.reply_to, .email.domain.root_domain == 'crowdstrike.com')
          )
          // if there isn't a reply-to, that's ok too
          or length(headers.reply_to) == 0
        )
    // return_path root_domain must be crowstrike.com
    and headers.return_path.domain.root_domain == 'crowdstrike.com'
  )
  
  // contains themed words based on Crowdstrikes Recommendations
  and (
    // safe mode and windows recovery
    strings.icontains(subject.subject, 'safe mode')
    or any(body.links, strings.icontains(.display_text, 'safe mode'))
    or strings.icontains(body.current_thread.text, 'safe mode')
    or strings.icontains(subject.subject, 'windows recovery')
    or any(body.links, strings.icontains(.display_text, 'windows recovery'))
    or strings.icontains(body.current_thread.text, 'windows recovery')
  
    // incident id
    or strings.icontains(subject.subject, 'C-00000291')
    or any(body.links, strings.icontains(.display_text, 'C-00000291'))
    or strings.icontains(body.current_thread.text, 'C-00000291')
  )
  
  // not high trust sender domains
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )

tactics_and_techniques:
  - "Impersonation: Brand"
  - "Lookalike domain"
  - "Spoofing"
detection_methods:
  - "Sender analysis"
  - "Content analysis"
